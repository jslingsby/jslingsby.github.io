---
title: "MODIS and Landsat primer for Hannah"
author: "Jasper Slingsby"
date: '2017-04-04'
image: /img/jonaskop_landsat.png
slug: modis-primer-for-hannah
tags: ["remote sensing", "All"]
categories: ["R Tutorials", "All", "Research"]
---

This is a quick primer on how to handle MODIS and Landsat NDVI data from [**Google Earth Engine (GEE)**](https://earthengine.google.com/) in R. It's primarily for my Honours student, Hannah Simon, but I thought why not make it public for all to share? I first posted the MODIS section and had Hannah play with the Landsat data as a learning exercise, so full credit to her for the Landsat code.

For a general introduction for many of the functions used and handling spatial data in general see [**A Primer for Handling Spatial Data in R**](https://jslingsby.github.io/post/2017-04-01-PrimerSpatialData/) posted previously.

We start by getting the necessary libraries:

<br>

```{r}
#Get libraries
library(raster) #to handle rasters
library(rgdal) #to handle shapefiles
library(reshape) #for data wrangling
library(ggplot2) #for pretty plotting
library(animation) #for silly animations

datwd <- "/Users/jasper/Documents/GIS/CFR/MODISforHannah/"
```

<br>

Now let's start with...

<br>

##MODIS

<br>

```{r}
#Get data
mNDVI <- stack(paste0(datwd, "2017043_MODIS_v1g_JNP_MOD_NDVI.tif")) #Note that the file has multiple bands so stack() is the easiest way to read all bands

mNDVI #See what the data look like
```

<br>

So we've pulled in the full record of NDVI from the "MODIS/MOD13Q1 16-day composite vegetation indices" product from the dawn of time (i.e. the 18th February 2000) until as recent as possible (6th March 2017), but you'll notice the names in the raster, e.g. `r names(mNDVI)[1]` aren't very informative, simply numbering the layers from 1 to `r length(names(mNDVI))`, but not giving us the dates... For some reason I still haven't worked out how to embed the dates in the .tif raster exported from GEE, so I save them manually from the console into a text file (stone age, I know, sorry...).

<br>

```{r}
metdat <- read.delim(paste0(datwd, "MODIS_metadata.txt"), sep = " ", header = F)

head(metdat)
```

<br>

Still not pretty, but getting closer...

<br>

```{r}
date <- substr(metdat[,3], start = 27, stop = 37)
date[1:5]
```

<br>

With a bit of squint-counting and trial and error we manage to use substr() to extract the dates!

But for R to treat them as dates we need to tell it they are dates with as.Date(), and specify the date format (see ?strptime).

<br>

```{r}
date <- as.Date(date, format = "%Y_%m_%d")
date[1:5]
```

<br>

Et voil√†!

So we now have a stack of MODIS NDVI images through time, and we know their dates. We can embed the dates into the raster like so:

<br>

```{r}
names(mNDVI) <- date

mNDVI #Have another look at the data
```

<br>

Great! But now you'll notice that the min and max values are rather strange (-32767 to 32767) when we know that NDVI can only range from -1 to 1, and rarely goes below 0. Very strange! Let's have a look at our first image.

<br>

```{r}
plot(mNDVI[[1]])
```

<br>

0 to 4000? Even stranger!

It turns out the issue is that GEE has exported the data in what appears to be a strange format to reduce the file size. We need to tell R how to interpret it by setting a gain and offset.

<br>

```{r}
NAvalue(mNDVI)=-32767
offs(mNDVI)=0
gain(mNDVI)=.0001
plot(mNDVI[[1]])
```

<br>

Much more reasonable!

Ok, so now we can begin to look at our questions; namely, how does MODIS NDVI vary in space and time?

But first, we should set our focal area.

<br>

```{r}
site <- readOGR(dsn=paste0(datwd, "Jonaskop 120m.kml"), layer="Jonaskop 120m.kml") # A Google Earth KML file
site <- spTransform(site, CRS(proj4string(mNDVI))) #Reproject to match the projection of the MODIS data (UTM 34S in this case)

plot(mNDVI[[1]])
plot(site, add=T)
```

<br>

It looks like we're wrangling a lot more MODIS data than we need to. Let's crop to out focal area...

<br>

```{r}
mNDVI <- crop(mNDVI, site, snap = "out") #"snap="out"" adds a buffer around the site

plot(mNDVI[[1]])
plot(site, add=T)
```

<br>

...and look at a few images through time.

<br>

```{r}
plot(mNDVI) #Note that R limits it to the first 16 images
```

<br>

Lots of variation in space! What about time?

<br>

```{r}
if(!file.exists("/Users/jasper/GIT/jslingsby.github.io_local/static/img/output/mNDVI.gif")) { # Check if the file exists
  saveGIF({
    for (i in 1:dim(mNDVI)[3]) plot(mNDVI[[i]],
                      main=names(mNDVI)[i],
                      legend.lab="NDVI",
                      col=rev(terrain.colors(length(c(seq(0,.7,.05),1)))),
                      breaks=seq(0,.7,.05))}, 
    movie.name = "/Users/jasper/GIT/jslingsby.github.io_local/static/img/output/mNDVI.gif", 
    ani.width = 600, ani.height = 500, 
    interval=.25)
}

```

![](/img/output/mNDVI.gif)

<br>

*NOTE: this writes a .gif to file and does not render in R (or R notebook), so I had to insert it in the Markdown script.

You could make it a lot prettier, but still pretty fancy. Not very useful for the print edition though. How about just a simple line graph? this requires extracting the data to a data.frame.

<br>

```{r}
dat <- as.data.frame(mNDVI)

dat[1:10,1:10] #look at the data
```

<br>

So each date is a column and each cell in space is a row in our data frame. This isn't ideal for plotting so let's reshape the data into long format.

<br>

```{r}
rownames(dat) <- paste0("A",1:20) #Add dummy column labels

dat <- as.data.frame(t(dat)) #transpose data.frame

dat$Date <- as.Date(rownames(dat), format = "X%Y.%m.%d")

dat <- melt(dat, id=c("Date"))

head(dat)
```

<br>

Now let's make some pretty pictures!

<br>

```{r}
ggplot(data = dat, aes(x = Date, y = value, colour = variable)) + geom_line()
```

<br>

Pretty neat! It looks like our site burnt in the summer of 2000/2001. Now let's split them up.

<br>

```{r}
ggplot(data = dat, aes(x = Date, y = value, colour = variable)) + geom_line() + facet_wrap(~variable)
```

<br>

Well there's definitely clear seasonality and, while subtle, there are differences among the cells. What do we see with...

<br>

##Landsat

<br>

First we read in the full record of data for Landsat 8 for our area of interest.

```{r}
lsNDVI <- stack(paste0(datwd,"Landsat/2017045_v1_LC8_L1T_TOA_Jonaskop_daily__2013-04-15-2017-03-25.tif")) #note that I have used LC8 (LandSat 8)
lsNDVI
```

<br>

Then the metadata with dates.

<br>

```{r}
metdat2 <- read.delim(paste0(datwd,"Landsat/LC8_L1T_TOA_metadata.txt"), sep = " ", header = F) 
head(metdat2) #first few rows of metdat
tail(metdat2) #last few rows of metdat (our data goes up to 25th march, 2017)
```

<br>

Extract the dates, embed into the raster and have a look at the first scene.

<br>

```{r}
date2 <- substr(metdat2[,2], start = 0, stop = 10) #will extract YYYY_MM_DD
names(lsNDVI) <- date2 #assign the date to the 'names' of each NDVI value
plot(lsNDVI[[1]]) 
```

<br>

Looks good, but the scale's all wrong again, so we need to fix the gain and offset

<br>

```{r}
NAvalue(lsNDVI)=0
offs(lsNDVI)=-1.5
gain(lsNDVI)=.001
plot(lsNDVI[[1]])
plot(site, add=T)
```

<br>

Better! But still suspiscious... Note that I hacked the offset at -1.5 (it's usually 2) I'll need to recheck what the gain and offset values should be and fix this later...

<br>

Now let's zoom in on our focal site

<br>

```{r}
lsNDVI <- crop(lsNDVI, site, snap = "out") #"snap="out"" adds a buffer around the site

plot(lsNDVI[[1]])
plot(site, add=T)
```

<br>

Now let's have a look at the variation in both space and time.

<br>

```{r}
plot(lsNDVI)
```

<br>

Lots of errors because of NA's! It looks like some scenes are empty, while others are dominated by cloud (we applied a cloud masking algorithm in GEE). We'll need to get rid of these. Note that this isn't a problem with the MODIS data, because the MODIS data are an 8-day composite based on 2 scenes per day (i.e the choice of 16 scenes to make up one complete one). We can easily exclude the blank Landsat scenes by identifying those with NA values only (if the minimum or maximum value is NA, then there are no values other than NA).

<br>

```{r}
metdat2 <- metdat2[-which(is.na(minValue(lsNDVI))),] #Drop empty scenes from metadata
lsNDVI <- lsNDVI[[-which(is.na(minValue(lsNDVI)))]] #Drop empty scenes from rasterStack
```

<br>

Now we can look at variation through time using an animation as we did before. Note that in the previous plots the colour range varies. For the animation we need to set a fixed colour range so that a particular shade of green or yellow represents the same value across scenes. For the Landsat data these range from `r min(minValue(lsNDVI))` to `r max(maxValue(lsNDVI))`

<br>

```{r}
if(!file.exists("/Users/jasper/GIT/jslingsby.github.io_local/static/img/output/lsNDVI.gif")) { # Check if the file exists
  saveGIF({
    for (i in 1:dim(lsNDVI)[3]) plot(lsNDVI[[i]],
                      main=names(lsNDVI)[i],
                      legend.lab="NDVI",
                      col=rev(terrain.colors(length(c(seq(min(minValue(lsNDVI)),max(maxValue(lsNDVI)),.01),1)))),
                      breaks=seq(min(minValue(lsNDVI)),max(maxValue(lsNDVI)),.01))}, 
    movie.name = "/Users/jasper/GIT/jslingsby.github.io_local/static/img/output/lsNDVI.gif", 
    ani.width = 600, ani.height = 500, 
    interval=.25)
}

```

![](/img/output/lsNDVI.gif)

<br>

Looks like there's generally lower NDVI in the lower righthand corner parhaps?

<br>

Let's look at some time-series graphs. First the data wrangling, then plotting; following just about the same formula as for the MODIS data.

<br>

```{r}
ldat <- as.data.frame(lsNDVI)

#ldat[1:10,1:10] #look at the data

rownames(ldat) <- paste0(1:nrow(ldat)) #dummy column labels

ldat <- as.data.frame(t(ldat)) #transpose data.frame

ldat$Date <- as.Date(rownames(ldat), format = "X%Y.%m.%d")

ldat <- melt(ldat, id=c("Date"))

colnames(ldat)<- c("Date","Pixel.Number","NDVI.Value")

#head(ldat)

NDVIplot2 <- ggplot(data = ldat, aes(x = Date, y = NDVI.Value, colour = Pixel.Number)) + geom_line() + theme(legend.position="none") #remove legend as plot space cannot accommodate it - there are >800 pixels!

NDVIplot2 
```

<br>

So we still pick up some nice seasonality! Note this is "zoom in" on just the last ~4 years. It is a bit messy with all >800 pixels though, so let's select just a few.

<br>

Converting a rasterStack into a data.frame fills the dataframe with raster cell values by row from left to right and numbers them. We know there are 28 rows and 31 columns (= 868 pixels), so we can use this to sample cells of interest.

This is how the grid is numbered:

<br>

```{r}
matrix(1:868, 28, 31, byrow = T)
```

<br>

So let's take a few from the bottom right (where the NDVI is generally low):

<br>

```{r}
lowc <- c(614, 617, 707, 710)
highc <- c(128, 131, 221, 224)

lowdat <- subset(ldat, Pixel.Number%in%lowc)
highdat <- subset(ldat, Pixel.Number%in%highc)

NDVIplot_low <- ggplot(data = lowdat, aes(x = Date, y = NDVI.Value, colour = Pixel.Number)) + geom_line() #+ theme(legend.position="none") #remove legend as plot space cannot accommodate it - there are >800 pixels!

NDVIplot_low 
```

<br>

And a few from the top left (where the NDVI is generally high):

<br>

```{r}
NDVIplot_high <- ggplot(data = highdat, aes(x = Date, y = NDVI.Value, colour = Pixel.Number)) + geom_line() #+ theme(legend.position="none") #remove legend as plot space cannot accommodate it - there are >800 pixels!

NDVIplot_high

```


