---
title: Humans and forests in a changing sea of fire
author: ''
date: '2017-06-28'
slug: fire-shadows
image: /img/forestyoung.jpg
categories:
  - Research
tags: []
---

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
```

<center>![](/img/scienceinprogress/sip1.jpg)</center>

<br>

This is a study recently completed by one of my MSc students, Annabelle Rogers, who I co-supervised with Prof [**Ed February**](http://www.biologicalsciences.uct.ac.za/bio/staff/academic/february) and [**Glenn Moncrieff**](https://scholar.google.co.za/citations?user=_FFdaCUAAAAJ&hl=en). We're busy writing it up for publication, but here's a little preview. 

<br>

The study was inspired by [**this great paper**](https://researchspace.csir.co.za/dspace/handle/10204/2045) published by Dr Coert Geldenhuys in 1994, explaining how fire determines the distribution of forests in the Southern Cape. You can also read about it, and get a nice intro to our forests, in this interesting [**SA Forestry Online article**](http://saforestryonline.co.za/articles/southern-cape-forests-survive-largely-unchanged-for-centuries/). 

<br>

The premise of the Geldenhuys study was that certain parts of the landscape are protected from fire due to topographic features interacting with the prevailing winds to create "fire shadows", where fires will rarely occur. Forests establish and expand in these areas, but are periodically "trimmed back" when severe conditions allow fires to burn into the otherwise non-flammable forest edge.

<br>

Our hypothesis, beyond confirming the work by Geldenhuys, was that land cover transformation (e.g. urban expansion) is altering the flow of fire through the landscape and creating new or larger fire shadows.

<br>

The footprint of the City of Cape Town has expanded quite drastically since the 1940s, providing a good site for this study. Here's a little Youtube clip I put together using the 1:50 000 topo maps of the City made available by OpenStreetMaps [**here**](http://htonl.dev.openstreetmap.org/50k-ct/#11/-34.1232/18.7066/c2010).

<br>

[![city of cape town](https://i.ytimg.com/vi/qmscq6-25z0/0.jpg)](https://youtu.be/qmscq6-25z0)

<br>

Another advantage is that [**Zo&#235; Poulsen and Timm Hoffman**](https://www.researchgate.net/profile/Zoe_Poulsen/publication/279234745_Changes_in_the_distribution_of_indigenous_forest_in_Table_Mountain_National_Park_during_the_20th_Century/links/57a9c7b508aef300152aa8b3.pdf) mapped the change in indigenous forest extent in Table Mountain National Park over the period 1944 to 2008, providing the perfect dataset to validate our models and test our hypothesis.   

<br>

So, we set Annabelle the task of modelling fire on the Cape Peninsula with and without (i.e. pre-settlement) transformation, to identify areas where the probability of burning may have been affected. This gives us a map of "change in burn probability" and highlights areas that have become fire shadows, which we can compare to the change in forest extent.

<br>

I'm not going to go into the details of the fire modelling, including topographic features, developing a fuel model, wind fields and iterations of random ignitions. If you'd like to know more, you'll have to wait for the paper. Here I present the burn probability maps and quantify the change in burn probability in relation to forest expansion.

<br>

First, let's look at the reduction in burn probabilities when we "disrupt" the fire catchments by making the transformed areas non-flammable. I'll only present the simple case where we use a homogenous fuel model - i.e. all vegetation burns on the Peninsula in the same way. In reality the vegetation types can differ in flammability quite considerably, especially fynbos vs forest.

<br>

Here we present the burn probabilities with transformation, the burn probabilities without transformation, and the difference between the two.

**NOTE**: I present the code from the R statistical programming language used to do the analysis. Just skip these if you are only interested in the story. I've tried to write this so that it makes sense without the code, but include the code for Annabelle and other students interested in performing this kind of analysis. Send me a comment below or [**email**](http://www.ecologi.st/contact/) if you feel I haven't got this right. The code appears in grey boxes, and the output of the code appears either as the images or grey boxes with all lines preceeded by "##".

<br>

```{r, message = F}
library(raster)
library(rgdal)
library(spBayes)
library(rgeos)
library(dplyr)
library(ggplot2)
library(cleangeo)

datwd <- "/Users/jasper/Dropbox/SAEON/Projects/Cape Peninsula/FireShadow/"

#Get and stack files
change <- raster(paste0(datwd,"BP/changeHomog_clip.asc"))
proj4string(change) <- "+proj=utm +zone=34 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"
transformed <- raster(paste0(datwd,"BP/trans_homog_clip.asc"))
proj4string(transformed) <- "+proj=utm +zone=34 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"
untransformed <- raster(paste0(datwd,"BP/untrans_homog_clip.asc"))
proj4string(untransformed) <- "+proj=utm +zone=34 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"
untransformed <- projectRaster(untransformed, transformed)

bp <- stack(untransformed, transformed, change)

plot(bp)
```

<br>

Apologies for the funny names, but that's what Annabelle called them. "untrans_homog_clip" = the outputs based on the untransformed landscape using a homogenous fuel model, as opposed to the transformed landscape "trans..." and the difference between the two "change..."

Now let's get the forest change layers from Poulsen and Hoffman 2015 and plot forest change around Table Mountain.

<br>

```{r, message=FALSE}
f1944 <- readOGR(paste0(datwd, "forest/forestUTM1944.shp"), "forestUTM1944") #Get the layers
f2008 <- readOGR(paste0(datwd, "forest/forestUTM2008.shp"), "forestUTM2008")

###Ignore this code for now. It's a nicer way of plotting the map, but...
# f2008[205,] #Orangekloof polygon needs fixing!!!
# f1944@data$id = rownames(f1944@data)
# f1944=gUnionCascaded(f1944,id=f1944$id)%>%
#   gSimplify(0.001,topologyPreserve = T) #Fix topology issues
# 
# f2008@data$id = rownames(f2008@data)
# f2008=gUnionCascaded(f2008,id=f2008$id)%>%
#   gSimplify(0.001,topologyPreserve = T) #Fix topology issues

# map <- ggplot(f2008) + 
# aes(long, lat, group = group, fill = "#4393C3") + 
# geom_polygon(alpha = 0.5) +
# coord_equal() + 
# theme(legend.position="none")

sf1944 <- crop(f1944, extent(255000, 270000, 6230000, 6240000))
#sf2008 <- crop(f2008, extent(255000, 270000, 6230000, 6240000))

plot(sf1944, col = "forestgreen", border = "white")
plot(f2008, add = T, col = "green", border = "white")
plot(f1944, add = T, col = "forestgreen")

```

<br>

Here the dark green is the forest extent in 1944, while the light green indicates the additional forest extent in 2008 - lots of expansion!

<br>

Now I'd like to overlay the burn probabilities with the areas that were "stable fynbos" vs "stable forest" vs "forest expansion" over the 1944 to 2008 period and show you the difference as boxplots, but to work with them we'll need them as raster data (i.e. gridded as opposed to polygons). So first I rasterize each layer to a 90m grid and plot fynbos (0), stable forest (2) and areas of forest expansion (1).

<br>

```{r}
fr1944 <- rasterize(f1944, bp, fun = "count", field = 1, background = 0) #create a raster with "1" where forest occurred
fr2008 <- rasterize(f2008, bp, fun = "count", field = 1, background = 0) #create a raster with "1" where forest occurred

frDelta <- fr2008 + fr1944

plot(crop(frDelta, extent(255000, 270000, 6230000, 6240000)))

```

<br>

Now we can extract them into one dataframe (i.e. a table of data) and bin them into vegetation change classes...

<br>

```{r}
dat <- as.data.frame(na.omit(rasterToPoints(stack(bp, frDelta))))

dat$layer[which(dat$layer == 0)] <- "Stable Fynbos"
dat$layer[which(dat$layer == 1)] <- "Forest Gain"
dat$layer[which(dat$layer %in% c(2,3))] <- "Stable Forest" #Note there is some erroneous overlap in the 2008 polygons

dat$layer <- as.factor(dat$layer)

head(dat)
```

<br>

So there's the top few lines of the table above. Now we use these data to draw a box and whisker plot of the reduction in burn probability by class.

<br>

```{r}
g <- ggplot(dat)
g <- g + stat_boxplot(aes(y = changeHomog_clip, x = layer, group = layer), position = "dodge") + 
  ylab("Reduction in burn probability") + 
  xlab("Vegetation Change")
g #to plot

```

<br>

Clearly forest has remained stable and/or expanded in the areas where there has been a reduction in burn probability, but this plot wouldn't ever fool journal reviewer number three...

<br>

[![journal reviewer number three](http://img.youtube.com/vi/-VRBWLpYCPY/0.jpg)](https://www.youtube.com/watch?v=-VRBWLpYCPY)

<br>

They'll argue there's spatial autocorrelation (i.e. things that are close in space are likely to be similar anyway) and will want to see some fancy spatially explicit statistics that don't tell you any more than this boxplot.

So here are some convolutedly fancy stats for those of you who are interested. Skip to the brief discussion at the end if you're not interested in the stats :)

We'll start by thinning the data a little by subsampling. Running a spatially explicit Bayesian model on the ~34000 data points (i.e. 90m grid cells) we have requires a very very big computer, and this is just a blog post. Let's try 10% of the data and plot it to check that it's representative of the full dataset (as plotted above).

<br>

```{r}
set.seed(1) #Pick a string of random numbers so that we can replicate the sampling

sdat <- dat[sample(1:nrow(dat), nrow(dat)/10),] #Take a 10% sample

g <- ggplot(sdat)
g <- g + stat_boxplot(aes(y = changeHomog_clip, x = layer, group = layer), position = "dodge") + 
  ylab("Reduction in burn probability") + 
  xlab("Vegetation Change Class")
g #Plot the sample to see if it is representative of the whole

```

<br>

Looks pretty good. 

It turns out it takes ~12 hours to run the following code on the 10% subset of the data on a x86_64-apple-darwin13.4.0 MacBook Pro (so I've commented out the next code chunk so I don't have to run it each time I compile this blog post). I think we'll need to run the full dataset on a cluster...

Skip this section if you're more interested in the results.

<br>

```{r}
# ### Set up a convolutedly long set of model inputs which I won't eplain
# B <- as.matrix(c(1:3))
# p <- length(B)
# 
# sigma.sq <- 2
# tau.sq <- 0.1
# phi <- 3/0.5
# 
# n.samples <- 2000
# 
# starting <- list("phi"=3/0.5, "sigma.sq"=50, "tau.sq"=1)
# 
# tuning <- list("phi"=0.1, "sigma.sq"=0.1, "tau.sq"=0.1)
# 
# ### Set up 2 sets of different "prior beliefs" to see how much this affects the model - note that I've just gone with some simple ones here and should really explore a bigger range
# priors.1 <- list("beta.Norm"=list(rep(0,p), diag(1000,p)),
#                  "phi.Unif"=c(3/1, 3/0.1), "sigma.sq.IG"=c(2, 2),
#                  "tau.sq.IG"=c(2, 0.1))
# 
# priors.2 <- list("beta.Flat", "phi.Unif"=c(3/1, 3/0.1),
#                  "sigma.sq.IG"=c(2, 2), "tau.sq.IG"=c(2, 0.1))
# 
# ### Choose a model for the spatial autocorrelation
# cov.model <- "exponential" #A very rapid decay model. This should be fair for our data, but I'll need to play with this for publication
# 
# n.report <- 500
# verbose <- TRUE
# 
# ###Run the models
# m.1 <- spLM(changeHomog_clip~layer, coords=as.matrix(sdat[,1:2]),
#             data = sdat, starting=starting,
#             tuning=tuning, priors=priors.1, cov.model=cov.model,
#             n.samples=n.samples, verbose=verbose, n.report=n.report)
# 
# m.2 <- spLM(changeHomog_clip~layer, coords=as.matrix(sdat[,1:2]),
#             data = sdat, starting=starting,
#             tuning=tuning, priors=priors.2, cov.model=cov.model,
#             n.samples=n.samples, verbose=verbose, n.report=n.report)
# 
# burn.in <- 0.5*n.samples
# 
# ###Recover beta and spatial random effects
# m.1 <- spRecover(m.1, start=burn.in, verbose=FALSE)
# m.2 <- spRecover(m.2, start=burn.in, verbose=FALSE)
# 
# round(summary(m.1$p.theta.recover.samples)$quantiles[,c(3,1,5)],2)
# round(summary(m.2$p.theta.recover.samples)$quantiles[,c(3,1,5)],2)
# 
# round(summary(m.1$p.beta.recover.samples)$quantiles[,c(3,1,5)],2)
# round(summary(m.2$p.beta.recover.samples)$quantiles[,c(3,1,5)],2)
# 
# m.1.w.summary <- summary(mcmc(t(m.1$p.w.recover.samples)))$quantiles[,c(3,1,5)]
# m.2.w.summary <- summary(mcmc(t(m.2$p.w.recover.samples)))$quantiles[,c(3,1,5)]
#
# save(m.1, paste0(datwd, "model1.RData"))
```

<br>

Here's one I prepared earlier ;)

<br>

```{r}
load(paste0(datwd, "model1.RData")) #Get previously run model output

#round(summary(m.1$p.theta.recover.samples)$quantiles,2) #If you're running this code this gives you the spatial autocorrelation estimates

round(summary(m.1$p.beta.recover.samples)$quantiles,3)
```

<br>

So this gives us the median (50%) and quantiles (0.025, 0.25, 0.75, 0.975) of the posterior probability distributions for each class. "Forest Gain" is the intercept, which is all positive (i.e. lower probability of burning), and overlaps with "Stable Forest", but does not overlap with "Stable Fynbos", which confirms what we knew already! Although it's a little difficult to interpret. Let's try a boxplot to illustrate this more clearly.

<br>

```{r}
x <- as.data.frame(round(summary(m.1$p.beta.recover.samples)$quantiles,3))

rownames(x) <- levels(sdat$layer)
colnames(x) <- c("min", "lower", "mid", "upper", "max")
  
#m.1.w.summary <- summary(mcmc(t(m.1$p.w.recover.samples)))$quantiles[,c(3,1,5)]

Pa <-  ggplot(x,aes(rownames(x))) +
  geom_boxplot(aes(ymin=min,lower=lower,middle=mid,upper=upper,ymax=max),
              stat="identity") +
   ylab("Reduction in burn probability") + xlab("Vegetation Change Class")

Pa
```

<br>

So the forest expanded at sites where the probability of burning has been reduced, because land cover transformation has created new "fire shadows". Null hypothesis accepted?

Note that there are a bunch of assumptions etc that I haven't included here. E.g. having more people usually increases ignitions, resulting in more fires. This may also have I biased spatial pattern, like fires are most likely to start along the wildland-urban interface, etc. 

Either way, I think there are many reasons why this analysis is interesting despite it's flaws, and I suspect the story is at least partially true. The real question is how can we manage this? Do we allow these areas to succeed to forest, despite the loss of fynbos biodiversity at these sites? And the risk of catestrophically big fires if a fire is started in the ~50-100 year period while the fynbos is being invaded by forest and is incredibly flammable?

<br>

For the reviewer #3's among you - here are the model diagnostics:

<br>

```{r}
plot(m.1$p.beta.recover.samples)
```

It looks like the model converged nicely :)

<br>

