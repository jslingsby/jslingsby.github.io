<!DOCTYPE html>
<html lang="en-us">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

 <title>A Primer for Handling Spatial Data in R (Updated)</title>



<meta name="description" content="Ecological research and global change in South Africa">


<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="//fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">
<link rel="stylesheet" href="/css/font-awesome.min.css">

<link href="/css/style.default.css" rel="stylesheet" id="theme-stylesheet">

<link href="/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="/img/favicon.png">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-97038958-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
  <body>
    <div id="root">
      <div class="container-fluid">
        <div class="row site-header">
          <div class="col-md-12">
            <div class="row">
              <div class="col-md-12 top-navigation">
                <div class="row">
  <div class="col-sm-6">
    <div class="categories-block">
      <a href="" class="track-categories">//</a>
      
      <a href="/categories/all">all</a>
      
      <a href="/categories/r-tutorials">r-tutorials</a>
      
      <a href="/categories/research">research</a>
      
    </div>
  </div>

  <div class="col-sm-6">
    <div class="social-media-block">

      
      
      
      <a href="https://twitter.com/JasperSlingsby" data-animate-hover="pulse" class="external twitter">
        <i class="fa fa-twitter"></i>
      </a>
      
      
      
      <a href="mailto:jslingsby@gmail.com" data-animate-hover="pulse" class="email">
        <i class="fa fa-envelope"></i>
      </a>
      
      
      
      
      <a href="https://github.com/jslingsby/" data-animate-hover="pulse">
        <i class="fa fa-github"></i>
      </a>
      

    </div>
  </div>
</div>

              </div>
            </div>
            <div class="row">
              <div class="col-md-10 header col-md-offset-1">
                <div class="row">
  <div class="col-md-6">
    <div class="title-info">
      
      <a href=""> Jasper Slingsby </a>
      
    </div>
  </div>
  <div class="col-md-6">
    <div class="menu">
      <a href="/">Home /</a>
      
      
      <a href="/about">about / </a>
      
      
      
      <a href="/contact">contact / </a>
      
      
      
      
      
      <a href="/publications">publications / </a>
      
      
      
      <a href="/research">research / </a>
      
      
      
      <a href="/students">students / </a>
      
      
    </div>
  </div>

</div>


              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-10 main-content col-md-offset-1">
            

<div class="col-md-12 entry">
  <div class="row">
    <div class="col-md-12">
      <div class="entry-meta">
        29 June 2017
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="entry-header">
       A Primer for Handling Spatial Data in R (Updated)
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-2">
      <div class="entry-sidebar">
        CATEGORIES
        <div class="entry-categories">
          <a href="">All</a>
        </div>

        Tags
        <div class="entry-tags">
          <a href="">All</a>
        </div>
      </div>
    </div>
    <div class="col-md-10">
      <div class="entry-content">
        <div id="TOC">
<ul>
<li><a href="#installing-r-and-rstudio">Installing R (and RStudio)</a></li>
<li><a href="#cran-task-views-see-link-from-httpscran.r-project.org">CRAN Task Views!!! (see link from <a href="https://cran.r-project.org/" class="uri">https://cran.r-project.org/</a>)</a><ul>
<li><a href="#topics-covered-by-the-spatial-task-view-which-focuses-on-analysis-of-spatial-data">Topics covered by the <em>Spatial</em> Task View, which focuses on “Analysis of Spatial Data”:</a></li>
</ul></li>
<li><a href="#useful-diy-resources">Useful DIY resources</a></li>
<li><a href="#a-practical-example">A Practical Example!!!</a><ul>
<li><a href="#a-quick-note-on-the-structure-of-this-tutorial">A quick note on the structure of this tutorial</a></li>
<li><a href="#data-description">Data Description</a></li>
<li><a href="#housekeeping">Housekeeping</a></li>
<li><a href="#getting-and-cleaning-the-data-but-first-and-foremost-projection">Getting and cleaning the data, but first and foremost, <em>projection!!!</em></a></li>
<li><a href="#lets-start-with-point-data-mostly-functions-from-libraryrgdal-and-librarysp">Let’s start with point data (mostly functions from library(rgdal) and library(sp))</a></li>
<li><a href="#raster-data-mostly-functions-from-libraryraster">Raster data (mostly functions from library(raster))</a></li>
<li><a href="#polygons">Polygons!</a></li>
<li><a href="#going-parallel">Going parallel!</a></li>
<li><a href="#animation">Animation!</a></li>
<li><a href="#some-other-data-visualization-and-analysis">Some other data visualization and analysis</a></li>
<li><a href="#but-what-about-our-poor-cedars">But what about our poor cedars?</a></li>
<li><a href="#options-for-writing-out-spatial-data">Options for writing out spatial data</a></li>
</ul></li>
</ul>
</div>

<p>Points, lines, polygons and rasters - R can handle them all. My aim for this tutorial is to give you the basics required to teach yourself spatial data analysis in R.</p>
<!--more-->
<p>I’ll start by briefly covering installing R, CRAN Task Views and how to install them (using the ‘Spatial’ task view as an example), followed by some pointers for useful DIY resources for handling and analyzing spatial data, and then work through a practical example exploring fire history layers (polygon), topographic (raster) and locality (point) data using the libraries ‘rgdal’, ‘raster’ and ‘sp’ and a few others. The example will cover setting and changing projections and extents, subseting polygons, raster calculations, rasterizing polygons and extracting data with a few neat tricks and visualisations along the way.</p>
<p><br></p>
<div id="installing-r-and-rstudio" class="section level3">
<h3>Installing R (and RStudio)</h3>
<p>You can download R for Windows, Mac or Linux from <a href="https://cran.r-project.org/"><strong>The Comprehensive R Archive Network (CRAN) at https://cran.r-project.org/</strong></a> and install.</p>
<p>Base R can be quite clunky to deal with, so there is a range of additional software packages designed to help you manage your R code, plots, projects etc. One of the better ones (i.e. the one that I use and I’m clearly not bias) is <a href="https://www.rstudio.com/products/RStudio/"><strong>RStudio (www.rstudio.com)</strong></a>. You want to download the Open Source version of RStudio Desktop. When you open RStudio after installing you’ll see that it has opened R in the “Console” window.</p>
<p>Note that the base version of R is as small as possible, trimmed down to only the essential functions etc. More advanced and user specific functions are available as “Contributed Extension Packages” or “libraries”. You can access the list of packages from <a href="https://cran.r-project.org/" class="uri">https://cran.r-project.org/</a>. At the time of writing there were almost 11 000 packages and growing!!! This can be quite bewildering if you’re not sure what you need, but fortunately there are…</p>
<p><br></p>
</div>
<div id="cran-task-views-see-link-from-httpscran.r-project.org" class="section level2">
<h2>CRAN Task Views!!! (see link from <a href="https://cran.r-project.org/" class="uri">https://cran.r-project.org/</a>)</h2>
<p>Some great fellas have taken the time to sift through all the R libraries and make some sense of them for different focal topics and created “Task Views” <br></p>
<p>Each Task View has a landing page with an overview highlighting what you can do with the different packages and their respective strengths, weaknesses etc., e.g. <br> <br></p>
<div class="figure">
<img src="/img/CRAN_spatial.jpg" />

</div>
<div id="topics-covered-by-the-spatial-task-view-which-focuses-on-analysis-of-spatial-data" class="section level3">
<h3>Topics covered by the <em>Spatial</em> Task View, which focuses on “Analysis of Spatial Data”:</h3>
<ul>
<li>Classes for spatial data</li>
<li>Handling spatial data</li>
<li>Reading and writing spatial data</li>
<li>Reading and writing spatial data - other packages</li>
<li>Visualisation</li>
<li>Point pattern analysis</li>
<li>Geostatistics</li>
<li>Disease mapping and areal data analysis</li>
<li>Spatial regression</li>
<li>Ecological analysis</li>
</ul>
<p><br></p>
<p>Task Views also allow easy download and installation of all packages in a Task View using library(ctv) - see highlighted code below. But beware! It can take a while to download and install if it is a big Task View and the the Spatial one is BIG!!! You don’t need it for this tutorial, so don’t bother downloading it for now.</p>
<div class="figure">
<img src="/img/CRAN_taskviews.jpg" />

</div>
<p><br></p>
<hr />
<p><br></p>
</div>
</div>
<div id="useful-diy-resources" class="section level2">
<h2>Useful DIY resources</h2>
<ul>
<li>The Analysis of Spatial Data Task View!</li>
<li><a href="http://www.neondataskills.org" class="uri">http://www.neondataskills.org</a></li>
<li><a href="https://www.nceas.ucsb.edu/scicomp/solutions" class="uri">https://www.nceas.ucsb.edu/scicomp/solutions</a></li>
<li><a href="http://pakillo.github.io/R-GIS-tutorial/" class="uri">http://pakillo.github.io/R-GIS-tutorial/</a></li>
<li><a href="http://robinlovelace.net/" class="uri">http://robinlovelace.net/</a></li>
<li><a href="http://spatial.ly/" class="uri">http://spatial.ly/</a> - For some visual R inspiration!</li>
<li><a href="http://www.googleityoumoron.com" class="uri">http://www.googleityoumoron.com</a> - There are plenty of resources!!!</li>
<li>Applied Spatial Data Analysis with R - R. Bivand 2013</li>
</ul>
<p>A very good book!<br />
<img src="/img/Bivand.jpg" /></p>
<hr />
<p><br></p>
</div>
<div id="a-practical-example" class="section level2">
<h2>A Practical Example!!!</h2>
<p><br></p>
<div id="a-quick-note-on-the-structure-of-this-tutorial" class="section level3">
<h3>A quick note on the structure of this tutorial</h3>
<p>From here this tutorial will include embedded chunks of R code and the output that R returns in little grey boxes. The R code I call starts at the beginning of the line, while each line of R’s output starts with “##”, e.g.</p>
<pre class="r"><code>1+1</code></pre>
<pre><code>## [1] 2</code></pre>
<p><br></p>
<p>Note that I occassionally include comments in the R chunks. Comments are preceded by “#”. Hopefully this will all make sense as you get into the tutorial…</p>
<p><br></p>
</div>
<div id="data-description" class="section level3">
<h3>Data Description</h3>
<p>For this exercise we’ll play with fine-scale locality (point) data for the critically endangered Clanwilliam cedar (<em>Widdringtonia cedarbergensis</em>) mapped by my father for the new Cederberg hiking map (check out <strong><a href="http://www.slingsbymaps.com/" class="uri">http://www.slingsbymaps.com/</a></strong>; data for 1000 trees downloadable at <strong><a href="https://www.dropbox.com/s/1ucycs7vcaa5cm9/Cedars.kml?dl=0" class="uri">https://www.dropbox.com/s/1ucycs7vcaa5cm9/Cedars.kml?dl=0</a></strong>), a 90m (raster) digital elevation model (DEM) (<strong><a href="https://www.dropbox.com/s/xqjzeg8uypf45a2/SRTM.zip?dl=0" class="uri">https://www.dropbox.com/s/xqjzeg8uypf45a2/SRTM.zip?dl=0</a></strong>) that I will also show you how to download directly with R, and two “polygon” data sets consisting of mapped burn scars for CapeNature reserves (available at <strong><a href="http://bgis.sanbi.org/Projects/Detail/168" class="uri">http://bgis.sanbi.org/Projects/Detail/168</a></strong>) and the National Vegetation Map (available at <strong><a href="http://bgis.sanbi.org/SpatialDataset/Detail/18" class="uri">http://bgis.sanbi.org/SpatialDataset/Detail/18</a></strong>). You will need to download the cedar dataset into your chosen local data directory (see “datwd” below) and download the other data into your chosen GIS data directory (see “giswd” below) and unzip them. <em>datwd</em> and <em>giswd</em> can be the same for the purposes of this tutorial. You can download the R code (with the RMarkdown content commented out) at <strong><a href="https://www.dropbox.com/s/lkshqxmonq8fenc/PrimerSpatialData.R?dl=0" class="uri">https://www.dropbox.com/s/lkshqxmonq8fenc/PrimerSpatialData.R?dl=0</a></strong>.</p>
<hr />
<p><br></p>
</div>
<div id="housekeeping" class="section level3">
<h3>Housekeeping</h3>
<p>Let’s start by setting our working directories. I usually work from a “Project” in RStudio linked to a GIT repository (see <a href="https://git-scm.com/" class="uri">https://git-scm.com/</a> and <a href="https://github.com/" class="uri">https://github.com/</a>) for version control and easy code sharing/collaboration. I’m not going to go there with this tutorial, but it is worth exploring if you intend to do big projects in R. R projects set the working directory to a good place automatically. Alternatively you can use the setwd() function. If I’m not in a repo or I am working with large data sets that I don’t want to replicate in every GIT repo on my hard drive I usually set separate “data”, “GIS data” (i.e. biggish data) and “results” working directories by making each path an object and inserting as appropriate for different read and write functions using paste() or paste0(). These would look something like:</p>
<p>datwd = “/Users/jasper/Dropbox/SAEON/Training/SpatialDataPrimer/Example/Data/”<br />
giswd = “/Users/jasper/Documents/GIS/”<br />
reswd = “/Users/jasper/Dropbox/SAEON/Training/SpatialDataPrimer/Example/Results/”</p>
<p>But! This is not useful if I’m sharing the project or work on multiple machines. In this case it’s better to identify the machine/user using Sys.getenv() and wrap the code in an if() statement for each user like so:</p>
<p><br></p>
<pre class="r"><code>if (Sys.getenv(&quot;USER&quot;)==&#39;jasper&#39;) {datwd=&quot;/Users/jasper/Dropbox/SAEON/Training/SpatialDataPrimer/Example/Data/&quot;
giswd=&quot;/Users/jasper/Documents/GIS/&quot;
reswd=&quot;/Users/jasper/Dropbox/SAEON/Training/SpatialDataPrimer/Example/Results/&quot;}
if (Sys.getenv(&quot;USER&quot;)==&#39;MACUseR&#39;) {datwd=&quot;&quot;; giswd=&quot;&quot;; reswd=&quot;&quot;} #For Mac/Linux users
if (Sys.getenv(&quot;USERNAME&quot;)==&#39;WINDOZEUseR&#39;) {datwd=&quot;&quot;; giswd=&quot;&quot;; reswd=&quot;&quot;} #For Windows</code></pre>
<p><br></p>
<p>This way a new project member can add a new line of code without deleting anything, and it only sets the working directories (and any other settings you want) for the appropriate user - i.e. the if() statement ignores settings for all other users. NOTE!!! the “USER/USERNAME” difference for Mac vs Windows (I’m pretty sure Linux is the same as Mac, but try Sys.getenv() and see what you get).</p>
<p>Set your username and working directories here. You can just set <em>datwd</em>, <em>giswd</em> and <em>reswd</em> to the same file path for the purposes of this tutorial. Don’t forget to add the “/” at the end!</p>
<p>Note that we use single forwardslashes “/”. Windows likes to use single backslashes, but R (and just about every other computer programme in the world) doesn’t like this. You can use double backslashes on Windows if you must.</p>
<p>Now we can call the extention libraries we’ll need for this session. You should install these before running this code using install.packages() while connected to the internet - e.g. install.packages(“raster”). Note that one occasionally encounters issues installing doMC, but you can usually install it from their development page using install.packages(“doMC”, repos=“<a href="http://R-Forge.R-project.org" class="uri">http://R-Forge.R-project.org</a>”). If neither of these work for you don’t worry, it is not an essential component of the tutorial.</p>
<p><br></p>
<pre class="r"><code>library(raster, quietly = T) # To handle rasters
library(rasterVis, quietly = T) # For fancy raster visualisations
library(rgdal, quietly = T) # To communicate with GDAL and handle shape files</code></pre>
<pre><code>## Warning: package &#39;rgdal&#39; was built under R version 3.4.3</code></pre>
<pre><code>## rgdal: version: 1.2-16, (SVN revision 701)
##  Geospatial Data Abstraction Library extensions to R successfully loaded
##  Loaded GDAL runtime: GDAL 2.1.3, released 2017/20/01
##  Path to GDAL shared files: /Library/Frameworks/R.framework/Versions/3.4/Resources/library/rgdal/gdal
##  GDAL binary built with GEOS: FALSE 
##  Loaded PROJ.4 runtime: Rel. 4.9.3, 15 August 2016, [PJ_VERSION: 493]
##  Path to PROJ.4 shared files: /Library/Frameworks/R.framework/Versions/3.4/Resources/library/rgdal/proj
##  Linking to sp version: 1.2-5</code></pre>
<pre class="r"><code>library(sp, quietly = T) # To handle shapefiles
library(doMC, quietly = T) # To run code in parallel
library(animation, quietly = T) # To make fancy animations...
library(dismo, quietly = T) # For fancy tricks in Google Earth
library(googleVis, quietly = T) # For even more fancy tricks in Google Earth</code></pre>
<pre><code>## Creating a generic function for &#39;toJSON&#39; from package &#39;jsonlite&#39; in package &#39;googleVis&#39;</code></pre>
<pre><code>## 
## Welcome to googleVis version 0.6.2
## 
## Please read Google&#39;s Terms of Use
## before you start using the package:
## https://developers.google.com/terms/
## 
## Note, the plot method of googleVis will by default use
## the standard browser to display its output.
## 
## See the googleVis package vignettes for more details,
## or visit http://github.com/mages/googleVis.
## 
## To suppress this message use:
## suppressPackageStartupMessages(library(googleVis))</code></pre>
<hr />
<p><br></p>
</div>
<div id="getting-and-cleaning-the-data-but-first-and-foremost-projection" class="section level3">
<h3>Getting and cleaning the data, but first and foremost, <em>projection!!!</em></h3>
<p>R typically uses the PROJ.4 conventions for cartographic projections (or coordinate reference systems - CRS). Check out <a href="http://proj4js.org" class="uri">http://proj4js.org</a> or <a href="http://spatialreference.org/" class="uri">http://spatialreference.org/</a> or google for the “proj4string” for various coordinate reference systems.</p>
<p>I like to set a standardized CRS as an object that I use throughout my workflow.</p>
<p>NOTE!!! Many R functions will allow you to play with objects with different CRS resulting in GARBAGE! Others will reproject one or other of the objects for you, but this can be slow and it’s not worth taking the chance. I recommend checking and setting your CRS for all objects. You can check CRS with proj4string(), check that multiple objects have the same CRS using identicalCRS(), and reproject objects of class “Spatial” with spTransform() and objects of class “Raster” with projectRaster().</p>
<p><br></p>
<pre class="r"><code>#Set a standardized projection
stdCRS &lt;- &quot;+proj=utm +zone=34 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs&quot; 
#This is &quot;EPSG:32734&quot;</code></pre>
<p><br></p>
<p>I like to use Universal Transverse Mercator (UTM) for studies with smallish extents (~&lt;100km a side) because the unit is metres and is easily interpretable. The UTM zone we’re in for this example is 34 South <a href="http://whatutmzoneamiin.blogspot.co.za/p/map.html" class="uri">http://whatutmzoneamiin.blogspot.co.za/p/map.html</a>.</p>
<hr />
<p><br></p>
</div>
<div id="lets-start-with-point-data-mostly-functions-from-libraryrgdal-and-librarysp" class="section level3">
<h3>Let’s start with point data (mostly functions from library(rgdal) and library(sp))</h3>
<p>Here we use readOGR() from library(rgdal) to read the points in as a shapefile. Note that readOGR() is incredibly versatile and can be used to read in all kinds of shapefiles with different features (point, line, polygon) from different software. Unfortunately some PCs struggle to automatically install the GDAL <a href="http://www.gdal.org/" class="uri">http://www.gdal.org/</a> software that is called from R, but there are plenty of online fora providing solutions. Sometimes (although this issue may be fixed) there are conflicts between library(sp) and library(rgdal) depending on what order they are called.</p>
<p><br></p>
<pre class="r"><code>rawpts &lt;- readOGR(dsn=paste0(datwd, &quot;Cedars.kml&quot;), layer=&quot;Cedars.kml&quot;) # A Google Earth KML file</code></pre>
<pre><code>## OGR data source with driver: KML 
## Source: &quot;/Users/jasper/Dropbox/SAEON/Training/SpatialDataPrimer/Example/Data/Cedars.kml&quot;, layer: &quot;Cedars.kml&quot;
## with 1000 features
## It has 2 fields</code></pre>
<pre class="r"><code>proj4string(rawpts) # Check projection</code></pre>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<pre class="r"><code>pts &lt;- spTransform(rawpts, CRS(stdCRS)) # Do spatial transform to set projection</code></pre>
<p><br></p>
<p>Note the strange <em>dsn=/layer=</em> syntax. This will mess with you at first!!! This syntax is used to allow the function to read in many different file formats (type “ogrDrivers()” into the console to see a list). Different drivers often require different inputs for <em>dsn=</em> and <em>layer=</em>. I often have to play around or ask Google before I get it right for a new file…</p>
<p>Also note the use of the paste0(datwd, “Cedars.kml”) trick I mentioned earlier:</p>
<p><br></p>
<pre class="r"><code>paste0(datwd, &quot;Cedars.kml&quot;)</code></pre>
<pre><code>## [1] &quot;/Users/jasper/Dropbox/SAEON/Training/SpatialDataPrimer/Example/Data/Cedars.kml&quot;</code></pre>
<p><br></p>
<p>Note that the presence and number of /’s are very important… It’s the first thing to check if you get an error!!! IF YOU HAVE ANY ISSUES READING IN DATA AT ANY STAGE THE FIRST THING TO DO IS TO RUN THE “paste0(…)” SECTION OF THE SCRIPT AND MAKE SURE IT MATCHES EXACTLY THE PATH TO YOUR FILE!!!</p>
<p><br></p>
<p>Let’s explore our point data a little more and fiddle with different ways of making a “Spatial” object.</p>
<p><br></p>
<pre class="r"><code>class(pts)</code></pre>
<pre><code>## [1] &quot;SpatialPointsDataFrame&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<pre class="r"><code>head(coordinates(pts)) # Get the spatial coordinates</code></pre>
<pre><code>##      coords.x1 coords.x2
## [1,]  318630.2   6418166
## [2,]  329096.9   6411855
## [3,]  324656.3   6423442
## [4,]  324611.6   6427641
## [5,]  324156.0   6421462
## [6,]  320746.9   6429256</code></pre>
<pre class="r"><code>x &lt;- as.data.frame(coordinates(pts)) # Extract the coordinates and make them a regular &quot;data.frame&quot;&quot; object (as if we&#39;d read in a .txt or .csv file)
class(x)</code></pre>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<pre class="r"><code>coordinates(x) &lt;- ~ coords.x1 + coords.x2 # Set coordinates for x, making it a &quot;Spatial&quot; object
class(x)</code></pre>
<pre><code>## [1] &quot;SpatialPoints&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<pre class="r"><code>str(x) # Note the lack of proj4string info</code></pre>
<pre><code>## Formal class &#39;SpatialPoints&#39; [package &quot;sp&quot;] with 3 slots
##   ..@ coords     : num [1:1000, 1:2] 318630 329097 324656 324612 324156 ...
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. ..$ : chr [1:1000] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##   .. .. ..$ : chr [1:2] &quot;coords.x1&quot; &quot;coords.x2&quot;
##   ..@ bbox       : num [1:2, 1:2] 315518 6410827 333832 6434186
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. ..$ : chr [1:2] &quot;coords.x1&quot; &quot;coords.x2&quot;
##   .. .. ..$ : chr [1:2] &quot;min&quot; &quot;max&quot;
##   ..@ proj4string:Formal class &#39;CRS&#39; [package &quot;sp&quot;] with 1 slot
##   .. .. ..@ projargs: chr NA</code></pre>
<pre class="r"><code>proj4string(x) &lt;- stdCRS # To assign the CRS (IF IT IS KNOWN!!!)
str(x)</code></pre>
<pre><code>## Formal class &#39;SpatialPoints&#39; [package &quot;sp&quot;] with 3 slots
##   ..@ coords     : num [1:1000, 1:2] 318630 329097 324656 324612 324156 ...
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. ..$ : chr [1:1000] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##   .. .. ..$ : chr [1:2] &quot;coords.x1&quot; &quot;coords.x2&quot;
##   ..@ bbox       : num [1:2, 1:2] 315518 6410827 333832 6434186
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. ..$ : chr [1:2] &quot;coords.x1&quot; &quot;coords.x2&quot;
##   .. .. ..$ : chr [1:2] &quot;min&quot; &quot;max&quot;
##   ..@ proj4string:Formal class &#39;CRS&#39; [package &quot;sp&quot;] with 1 slot
##   .. .. ..@ projargs: chr &quot;+proj=utm +zone=34 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0&quot;</code></pre>
<pre class="r"><code>rm(x) # Remove x from R&#39;s memory as we won&#39;t need it again.</code></pre>
<p><br></p>
<p>Note the “@” symbols revealed when we look at the data structure (str()). Many spatial data objects use “slots” to store various components of the data. The slots can be accessed using “@” like you would “$” to call a variable from a dataframe, but it is RECOMMENDED THAT YOU DON’T DO THIS… The reason being that slots were designed so that the R package developers can change the way slots work to improve efficiency, handle new or different objects etc. If you write code that accesses slots directly it may break next time the libraries are updated. There are functions for accessing all slots (e.g. proj4string(), coordinates(), etc.)</p>
<hr />
<p><br></p>
</div>
<div id="raster-data-mostly-functions-from-libraryraster" class="section level3">
<h3>Raster data (mostly functions from library(raster))</h3>
<p>Let’s get a digital elevation model (DEM) from the SRTM90 (Shuttle Radar Topography Mission*) digital elevation database, match projection, and trim to the same extent as “pts”. We can download the data directly with R using the function getData() (type ?getData for details), but this can be slow because it downloads a much bigger area than we need. To save time I’ve downloaded the data before and saved it locally with the “path =” setting, hashed (#) out the download code so R won’t run it, and read the data in from the local source. You will need to run the hashed out code (without the hash) to download the data the first time you run this script.</p>
<p>*Jarvis A., H.I. Reuter, A. Nelson, E. Guevara, 2008, Hole-filled seamless SRTM data V4, International Centre for Tropical Agriculture (CIAT), available from <a href="http://srtm.csi.cgiar.org" class="uri">http://srtm.csi.cgiar.org</a></p>
<p><br></p>
<pre class="r"><code>#dem &lt;- getData(&#39;SRTM&#39;, lon=19, lat=-32.5, path = paste0(giswd, &quot;SRTM/&quot;)) # download data from CGIAR website
dem &lt;- raster(paste0(giswd, &quot;SRTM/srtm_40_19.tif&quot;)) # read in data from local source - NOTE THAT YOU MAY NEED TO UNZIP THE FILE YOU DOWNLOADED!!!
proj4string(dem) # this is not our chosen projection for this tutorial so we need to reproject</code></pre>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<pre class="r"><code>dem &lt;- projectRaster(dem, crs=CRS(stdCRS)) # note that we use a different function for raster data than for shapefiles (points or polygon) - this can take a while...

extent(dem)</code></pre>
<pre><code>## class       : Extent 
## xmin        : -79731.16 
## xmax        : 409252.3 
## ymin        : 6109993 
## ymax        : 6681302</code></pre>
<pre class="r"><code>extent(pts) # so our DEM has a much larger extent than our cedars of interest and we should crop it</code></pre>
<pre><code>## class       : Extent 
## xmin        : 315517.9 
## xmax        : 333832.2 
## ymin        : 6410827 
## ymax        : 6434186</code></pre>
<pre class="r"><code>E &lt;- extent(pts) + c(-900, 900, -900, 900) # The second term adds a 900m buffer
dem &lt;- crop(dem, E) # Crop DEM to the buffered extent</code></pre>
<p><br></p>
<p>Lets have a look?</p>
<p><br></p>
<pre class="r"><code>plot(dem)
points(pts, pch=20, cex=.1)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p><br></p>
<p>Now that we have the DEM cleaned up for our study let’s use the terrain() function to calculate/extract some topographic information. Note that terrain() is based on the more versatile focal() function, should you want to design your own indices etc. Also see rasterEngine() in library(spatial.tools) which is an equivalent, but with easy parallel processing capability.</p>
<p><br></p>
<pre class="r"><code>slope &lt;- terrain(dem, &quot;slope&quot;)
aspect &lt;- terrain(dem, &quot;aspect&quot;)
TPI &lt;- terrain(dem, &quot;TPI&quot;) # Topographic Position Index
TRI &lt;- terrain(dem, &quot;TRI&quot;) # Terrain Ruggedness Index
roughness &lt;- terrain(dem, &quot;roughness&quot;)
flowdir &lt;- terrain(dem, &quot;flowdir&quot;)</code></pre>
<p><br></p>
<p>But “aspect” is circular so small changes in the northern aspects (e.g. 2 to 358 degrees) look like big changes in the data. We can break aspect down into east-westness and north-southness using sin() and cos() - remember your trigonometry?</p>
<p><br></p>
<pre class="r"><code>eastwest &lt;- sin(aspect)
northsouth &lt;- cos(aspect)</code></pre>
<p><br></p>
<p>Now dealing with all these different rasters gets a bit cumbersome, but they have the same extent, resolution and grid so we can stack() them into one object. But first, we should make sure the data are named in a sensible way otherwise they can all end out being named “layer”…</p>
<p><br></p>
<pre class="r"><code>names(eastwest)</code></pre>
<pre><code>## [1] &quot;layer&quot;</code></pre>
<pre class="r"><code>names(northsouth) </code></pre>
<pre><code>## [1] &quot;layer&quot;</code></pre>
<pre class="r"><code>names(dem)</code></pre>
<pre><code>## [1] &quot;srtm_40_19&quot;</code></pre>
<pre class="r"><code>names(eastwest) &lt;- &quot;eastwest&quot; # To rename the data in the raster
names(northsouth) &lt;- &quot;northsouth&quot;
names(dem) &lt;- &quot;dem&quot;
topo &lt;- stack(dem, slope, eastwest, northsouth, TPI, TRI, roughness, flowdir)
topo</code></pre>
<pre><code>## class       : RasterStack 
## dimensions  : 272, 257, 69904, 8  (nrow, ncol, ncell, nlayers)
## resolution  : 78.3, 92.4  (x, y)
## extent      : 314587.6, 334710.7, 6409924, 6435056  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=utm +zone=34 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0 
## names       :         dem,       slope,    eastwest,  northsouth,         tpi,         tri,   roughness,     flowdir 
## min values  : 296.3650828,   0.0006550,  -1.0000000,  -1.0000000, -70.5164504,   0.2751995,   0.8269874,   1.0000000 
## max values  : 1956.993141,    1.122555,    1.000000,    1.000000,   91.157818,  140.499398,  438.959923,  128.000000</code></pre>
<pre class="r"><code># Another way to rename rasters in a stack
# names(topo) &lt;- c(&quot;name1&quot;, &quot;name2&quot;&quot;, etc)</code></pre>
<p><br></p>
<p>Some other useful “raster” functions are rasterize(), aggregate() and raster calculations. Let’s calculate the tree density by 90m grid cell from the DEM.</p>
<p><br></p>
<pre class="r"><code>dens &lt;- rasterize(pts, dem, field=&quot;Name&quot;, fun=&quot;count&quot;)
plot(dens) # See anything? Probably not, these are 90m pixels in a large landscape...</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<pre class="r"><code>plot(aggregate(dens, fact=3, fun=&quot;sum&quot;))  # Aggregate the 90m cells into larger 210m cells - better?</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-13-2.png" width="672" /></p>
<pre class="r"><code>plot(dens&gt;10, col=&quot;red&quot;)  # Use raster calculations to subset</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-13-3.png" width="672" /></p>
<p><br></p>
<p>Note that you can add, subtract, multiply and divide rasters allowing you to easily do some quite complicated calculations. Explore calc() for designing and implementing more complicated functions.</p>
<p><br></p>
<hr />
<p><br></p>
</div>
<div id="polygons" class="section level3">
<h3>Polygons!</h3>
<p>Perhaps the best place to start is the National Vegetation Map of South Africa, Lesotho and Swaziland. We need to get the data, set the CRS and crop to our area/extent of interest.</p>
<p><br></p>
<pre class="r"><code>vegmap &lt;- readOGR(dsn=paste0(giswd, &quot;VegMap/nvm2012beta2_wgs84_Geo&quot;), layer=&quot;nvm2012beta2_wgs84_Geo&quot;) # Get the data</code></pre>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;/Users/jasper/Documents/GIS/VegMap/nvm2012beta2_wgs84_Geo&quot;, layer: &quot;nvm2012beta2_wgs84_Geo&quot;
## with 44822 features
## It has 21 fields</code></pre>
<pre class="r"><code>head(vegmap) # Have a look at the first 6 rows of the attribute table </code></pre>
<pre><code>##   OBJECTID_1                      NAME MAPCODE12 MPCDSUBT
## 0          0  Agulhas Limestone Fynbos      FFl1     &lt;NA&gt;
## 1          1  Agulhas Limestone Fynbos      FFl1     &lt;NA&gt;
## 2          2  Cape Seashore Vegetation      AZd3     &lt;NA&gt;
## 3          3  Cape Seashore Vegetation      AZd3     &lt;NA&gt;
## 4          4  Cape Seashore Vegetation      AZd3     &lt;NA&gt;
## 5          5 Overberg Sandstone Fynbos     FFs12     &lt;NA&gt;
##                      BIOREGION             BIOME CHANGE_VER  CHANGE_REF
## 0 South Coast Fynbos Bioregion            Fynbos       VM06 VegMap 2006
## 1 South Coast Fynbos Bioregion            Fynbos       VM06 VegMap 2006
## 2          Seashore Vegetation Azonal Vegetation       VM06 VegMap 2006
## 3          Seashore Vegetation Azonal Vegetation       VM06 VegMap 2006
## 4          Seashore Vegetation Azonal Vegetation       VM06 VegMap 2006
## 5   Southwest Fynbos Bioregion            Fynbos       VM06 VegMap 2006
##   CNSRV_TRGT SHAPE_LENG  SHAPE_AREA BIOMECODE GRPCODE               GROUP
## 0         32   5028.778   661226.69         F     FFl    Limestone Fynbos
## 1         32  25681.966 11720744.76         F     FFl    Limestone Fynbos
## 2         20   5624.948   332448.42        AZ     AZd Seashore Vegetation
## 3         20   2241.355    73488.36        AZ     AZd Seashore Vegetation
## 4         20  17366.045  1229468.26        AZ     AZd Seashore Vegetation
## 5         30   1295.837   120756.02         F     FFs    Sandstone Fynbos
##   BRGNCODE                            LEGEND VTYPSQKM12
## 0      F04   FFl 1  Agulhas Limestone Fynbos   294.4978
## 1      F04   FFl 1  Agulhas Limestone Fynbos   294.4978
## 2      AZd   AZd 3  Cape Seashore Vegetation   243.5824
## 3      AZd   AZd 3  Cape Seashore Vegetation   243.5824
## 4      AZd   AZd 3  Cape Seashore Vegetation   243.5824
## 5      F02 FFs 12  Overberg Sandstone Fynbos  1169.4725
##                         DOCLINK SUBTYPENM    BKSORT POLYSQKM
## 0 Descriptions\\FFl_1_2006.docx      &lt;NA&gt; 01 11 001   0.6612
## 1 Descriptions\\FFl_1_2006.docx      &lt;NA&gt; 01 11 001  11.7207
## 2 Descriptions\\AZd_3_2006.docx      &lt;NA&gt; 10 02 003   0.3324
## 3 Descriptions\\AZd_3_2006.docx      &lt;NA&gt; 10 02 003   0.0735
## 4 Descriptions\\AZd_3_2006.docx      &lt;NA&gt; 10 02 003   1.2295
## 5 Descriptions\\FFs12_2006.docx      &lt;NA&gt; 01 01 012   0.1208</code></pre>
<pre class="r"><code>extent(vegmap) # Check the extent</code></pre>
<pre><code>## class       : Extent 
## xmin        : 16.45696 
## xmax        : 32.8914 
## ymin        : -34.8334 
## ymax        : -22.12583</code></pre>
<pre class="r"><code>proj4string(vegmap) # Check the projection</code></pre>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<pre class="r"><code>vegmap &lt;- spTransform(vegmap, CRS(stdCRS)) # Reproject - This can take a while...
vegmap &lt;- crop(vegmap, E) # Note that extent (E) was created earlier</code></pre>
<pre><code>## Loading required namespace: rgeos</code></pre>
<p><br></p>
<p>Let’s plot what we’ve cropped…</p>
<p><br></p>
<pre class="r"><code>cols &lt;- rainbow(length(unique(vegmap$NAME))) # Make a set of 8 colours
plot(vegmap, col = cols[as.factor(as.character(vegmap$NAME))]) # Plot the map coloured by veg type
legend(&quot;bottomleft&quot;, legend = levels(as.factor(as.character(vegmap$NAME))), text.col = cols, cex=.6) # Add a legend
points(pts, pch=20, cex=.1) # Add the trees</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p><br></p>
<p>Looks like our cedars are restricted to “Cederberg Sandstone Fynbos”, but we can test that by extracting the veg type for each tree location.</p>
<p><br></p>
<pre class="r"><code># Note that there are a few ways of extracting data from spatial objects. The variants of over() are best for shapefiles
treeveg &lt;- over(pts, vegmap)
treeveg2 &lt;- pts %over% vegmap
identical(treeveg, treeveg2) #Same result!</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>head(treeveg) # We&#39;ve extracted the attribute table data for the vegtypes that each tree intersects</code></pre>
<pre><code>##   OBJECTID_1                       NAME MAPCODE12 MPCDSUBT
## 1       7421 Cederberg Sandstone Fynbos      FFs4     &lt;NA&gt;
## 2       7421 Cederberg Sandstone Fynbos      FFs4     &lt;NA&gt;
## 3       7421 Cederberg Sandstone Fynbos      FFs4     &lt;NA&gt;
## 4       7421 Cederberg Sandstone Fynbos      FFs4     &lt;NA&gt;
## 5       7421 Cederberg Sandstone Fynbos      FFs4     &lt;NA&gt;
## 6       7421 Cederberg Sandstone Fynbos      FFs4     &lt;NA&gt;
##                    BIOREGION  BIOME CHANGE_VER      CHANGE_REF CNSRV_TRGT
## 1 Northwest Fynbos Bioregion Fynbos       VM09 Helme (2007) WC         29
## 2 Northwest Fynbos Bioregion Fynbos       VM09 Helme (2007) WC         29
## 3 Northwest Fynbos Bioregion Fynbos       VM09 Helme (2007) WC         29
## 4 Northwest Fynbos Bioregion Fynbos       VM09 Helme (2007) WC         29
## 5 Northwest Fynbos Bioregion Fynbos       VM09 Helme (2007) WC         29
## 6 Northwest Fynbos Bioregion Fynbos       VM09 Helme (2007) WC         29
##   SHAPE_LENG SHAPE_AREA BIOMECODE GRPCODE            GROUP BRGNCODE
## 1    1590266 2151887041         F     FFs Sandstone Fynbos      F01
## 2    1590266 2151887041         F     FFs Sandstone Fynbos      F01
## 3    1590266 2151887041         F     FFs Sandstone Fynbos      F01
## 4    1590266 2151887041         F     FFs Sandstone Fynbos      F01
## 5    1590266 2151887041         F     FFs Sandstone Fynbos      F01
## 6    1590266 2151887041         F     FFs Sandstone Fynbos      F01
##                              LEGEND VTYPSQKM12
## 1 FFs 4  Cederberg Sandstone Fynbos   2512.221
## 2 FFs 4  Cederberg Sandstone Fynbos   2512.221
## 3 FFs 4  Cederberg Sandstone Fynbos   2512.221
## 4 FFs 4  Cederberg Sandstone Fynbos   2512.221
## 5 FFs 4  Cederberg Sandstone Fynbos   2512.221
## 6 FFs 4  Cederberg Sandstone Fynbos   2512.221
##                         DOCLINK SUBTYPENM    BKSORT POLYSQKM
## 1 Descriptions\\FFs_4_2006.docx      &lt;NA&gt; 01 01 004 2151.887
## 2 Descriptions\\FFs_4_2006.docx      &lt;NA&gt; 01 01 004 2151.887
## 3 Descriptions\\FFs_4_2006.docx      &lt;NA&gt; 01 01 004 2151.887
## 4 Descriptions\\FFs_4_2006.docx      &lt;NA&gt; 01 01 004 2151.887
## 5 Descriptions\\FFs_4_2006.docx      &lt;NA&gt; 01 01 004 2151.887
## 6 Descriptions\\FFs_4_2006.docx      &lt;NA&gt; 01 01 004 2151.887</code></pre>
<pre class="r"><code>summary(droplevels(treeveg$NAME)) # Note the use of droplevels! If you don&#39;t do this summary() will report all ~440 vegetation types in the country where cedars do not occur too...</code></pre>
<pre><code>##            Cederberg Sandstone Fynbos 
##                                   980 
##            Fynbos Riparian Vegetation 
##                                    14 
## Northern Inland Shale Band Vegetation 
##                                     5 
##             Olifants Sandstone Fynbos 
##                                     1</code></pre>
<p><br></p>
<p>So a few trees stray off Cederberg Sandstone Fynbos, but this could be errors in the veg mapping. Our vegmap is mostly mapped at 1:250 000 scale (i.e. ~2km error), while our tree locations are accurate to 10m…</p>
<p><br></p>
<p>Now let’s play with the fire record data we downloaded earlier. Firstly we get data the data and transform to our standard CRS as for the vegmap.</p>
<p><br></p>
<pre class="r"><code>#Get CapeNature fire data, reproject and trim to the &quot;extent&quot; of pts (+ a 900m buffer)
firelayers &lt;- readOGR(dsn=paste0(giswd, &quot;CFR/All_fires_15_16_gw&quot;), layer=&quot;All_fires_15_16_gw&quot;)</code></pre>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;/Users/jasper/Documents/GIS/CFR/All_fires_15_16_gw&quot;, layer: &quot;All_fires_15_16_gw&quot;
## with 3719 features
## It has 16 fields
## Integer64 fields read as strings:  ID</code></pre>
<pre class="r"><code>proj4string(firelayers)</code></pre>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<pre class="r"><code>firelayers &lt;- spTransform(firelayers, CRS(stdCRS))</code></pre>
<pre><code>## Warning in Polygon(coords = crds): less than 4 coordinates in polygon</code></pre>
<pre class="r"><code>extent(firelayers)</code></pre>
<pre><code>## class       : Extent 
## xmin        : 250253.7 
## xmax        : 733752.2 
## ymin        : 6150231 
## ymax        : 6453673</code></pre>
<p><br></p>
<p>The fire data covers all CapeNature reserves across the CFR. We could crop() to our extent (E), but there are other ways. Let’s explore and manipulate the data object a little.</p>
<p><br></p>
<pre class="r"><code>#str(firelayers) # Not useful when there are many layers (e.g. fires). It just prints out all the details for each of the ~3500 separate fire layers...
firelayers # Better</code></pre>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 3719 
## extent      : 250253.7, 733752.2, 6150231, 6453673  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=utm +zone=34 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0 
## variables   : 16
## names       :  ID,       FIRE_CODE, Res_code,  Region, Month, Year, Res_centre,                Res_name,                   Local_desc,  Datestart, DateExting, DateWithdr,     Report_off,    Polic_case,                    IgnitionCa, ... 
## min values  :   0, ANYS/00/1986/01,     ANYS, Central,     0, 1927,   Anysberg,            Anysberg MCA,                            ?, 1927/05/28, 1940/06/27, 1944/01/16,             ??,             -, Fire operations - Block burns, ... 
## max values  : 999, WBAY/12/2015/01,     WBAY, Western,    12, 2016,   Waterval, Zuurberg Nature Reserve, Zwartnek - west of Bergplaas, 2016/07/05, 7197/07/31, 2915/09/18, Zibele Blekiwe, yb285/11/2000,             Unknown - Unknown, ...</code></pre>
<pre class="r"><code>head(firelayers)</code></pre>
<pre><code>##     ID       FIRE_CODE Res_code  Region Month Year Res_centre
## 0 1340 OUTE/05/1927/01     OUTE Eastern     5 1927  Outeniqua
## 1 1112 SWBG/12/1930/01     SWBG Eastern    12 1930  Swartberg
## 2  771 SWBG/01/1931/01     SWBG Eastern     1 1931  Swartberg
## 3 1016 SWBG/08/1932/01     SWBG Eastern     8 1932  Swartberg
## 4  849 SWBG/02/1933/02     SWBG Eastern     2 1933  Swartberg
## 5  848 SWBG/02/1933/01     SWBG Eastern     2 1933  Swartberg
##                         Res_name                      Local_desc
## 0      Witfontein Nature Reserve                    3322CD - 342
## 1 Groot Swartberg Nature Reserve   Paardevley.3322BD.Fire no A1.
## 2 Groot Swartberg Nature Reserve  De Wetsvley.3322AC.Fire no A2.
## 3 Groot Swartberg Nature Reserve    Plaatberg.3321BD.Fire no.B1.
## 4 Groot Swartberg Nature Reserve    Grootvlei.3321BD.Fire no.C2.
## 5             Grootswartberg MCA Blauwpunt.3322AD-BC.Fire no C1.
##    Datestart DateExting DateWithdr Report_off Polic_case
## 0 1927/05/28       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;
## 1 1930/12/28       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;
## 2 1931/01/18       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;
## 3 1932/08/17       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;
## 4 1933/02/11       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;
## 5 1933/02/11       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;
##            IgnitionCa     Area_ha
## 0   Unknown - Unknown    3.852058
## 1 Natural - Lightning  172.562725
## 2 Natural - Lightning  198.357564
## 3     People - Farmer 2363.599963
## 4   Unknown - Unknown 2999.420641
## 5   Unknown - Unknown 5391.986432</code></pre>
<pre class="r"><code>names(firelayers)</code></pre>
<pre><code>##  [1] &quot;ID&quot;         &quot;FIRE_CODE&quot;  &quot;Res_code&quot;   &quot;Region&quot;     &quot;Month&quot;     
##  [6] &quot;Year&quot;       &quot;Res_centre&quot; &quot;Res_name&quot;   &quot;Local_desc&quot; &quot;Datestart&quot; 
## [11] &quot;DateExting&quot; &quot;DateWithdr&quot; &quot;Report_off&quot; &quot;Polic_case&quot; &quot;IgnitionCa&quot;
## [16] &quot;Area_ha&quot;</code></pre>
<pre class="r"><code>class(firelayers$Res_centre)</code></pre>
<pre><code>## [1] &quot;factor&quot;</code></pre>
<pre class="r"><code>levels(firelayers$Res_centre)</code></pre>
<pre><code>##  [1] &quot;Anysberg&quot;           &quot;Cederberg&quot;          &quot;De Hoop&quot;           
##  [4] &quot;De Mond&quot;            &quot;Driftsands&quot;         &quot;Gamkaberg&quot;         
##  [7] &quot;Ganzekraal&quot;         &quot;Geelkranz&quot;          &quot;Goukamma&quot;          
## [10] &quot;Grootvadersbosch&quot;   &quot;Grootwinterhoek&quot;    &quot;Hottentots-Holland&quot;
## [13] &quot;Jonkershoek&quot;        &quot;Kammanassie&quot;        &quot;Keurbooms&quot;         
## [16] &quot;Kogelberg&quot;          &quot;Limietberg&quot;         &quot;Marloth&quot;           
## [19] &quot;Matjiesrivier&quot;      &quot;Outeniqua&quot;          &quot;Riverlands&quot;        
## [22] &quot;Robberg&quot;            &quot;Swartberg&quot;          &quot;Towerkop&quot;          
## [25] &quot;Vrolijkheid&quot;        &quot;Walker Bay&quot;         &quot;Waterval&quot;</code></pre>
<pre class="r"><code>unique(firelayers$Res_centre)</code></pre>
<pre><code>##  [1] Outeniqua          Swartberg          Jonkershoek       
##  [4] Towerkop           Gamkaberg          Cederberg         
##  [7] Kammanassie        Kogelberg          Limietberg        
## [10] Vrolijkheid        Hottentots-Holland Grootvadersbosch  
## [13] Marloth            Grootwinterhoek    Waterval          
## [16] De Hoop            Anysberg           De Mond           
## [19] Walker Bay         Goukamma           Riverlands        
## [22] Keurbooms          Robberg            Driftsands        
## [25] Ganzekraal         Geelkranz          Matjiesrivier     
## [28] &lt;NA&gt;              
## 27 Levels: Anysberg Cederberg De Hoop De Mond Driftsands ... Waterval</code></pre>
<p><br></p>
<p>We can subset shapefiles based on fields in the attribute table using indexing, e.g. where the Res_centre = Cederberg in this case.</p>
<p><br></p>
<pre class="r"><code>firelayers &lt;- firelayers[which(firelayers$Res_centre==&quot;Cederberg&quot;),] # Note that each fire polygon is a separate row in the attribute table so R let&#39;s you subset as if you were working with a normal dataframe
firelayers$Res_centre &lt;- droplevels(firelayers$Res_centre) # Remove unwanted levels that were passed on from the original full extent
levels(firelayers$Res_centre)</code></pre>
<pre><code>## [1] &quot;Cederberg&quot;</code></pre>
<pre class="r"><code>plot(firelayers) # Plot (without colours)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p><br></p>
<p>Let’s use rasterize() to create a raster of the number of fires in each 90m pixel.</p>
<p><br></p>
<pre class="r"><code>firelayers$ID &lt;- 1:nrow(firelayers) # Add an unique ID for each fire
firecount &lt;- rasterize(firelayers, dem, field=&quot;ID&quot;, fun=&quot;count&quot;) # A count of all fires in each pixel
plot(firecount) # Note that the extent of our firelayers is larger than the DEM, but R trims it to the smaller extent automatically
points(pts, pch=20, cex=.1) # Add the trees</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p><br></p>
<p>Now lets rasterize() each fire (date) into it’s own raster, but first we need to look at the underlying data and see if this will work…</p>
<p><br></p>
<pre class="r"><code>names(firelayers)</code></pre>
<pre><code>##  [1] &quot;ID&quot;         &quot;FIRE_CODE&quot;  &quot;Res_code&quot;   &quot;Region&quot;     &quot;Month&quot;     
##  [6] &quot;Year&quot;       &quot;Res_centre&quot; &quot;Res_name&quot;   &quot;Local_desc&quot; &quot;Datestart&quot; 
## [11] &quot;DateExting&quot; &quot;DateWithdr&quot; &quot;Report_off&quot; &quot;Polic_case&quot; &quot;IgnitionCa&quot;
## [16] &quot;Area_ha&quot;</code></pre>
<pre class="r"><code>firelayers$Datestart</code></pre>
<pre><code>##   [1] 1944/01/01 &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       1948/02/01
##   [7] 1955/02/11 1956/04/01 1956/04/15 &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;      
##  [13] 1958/03/29 &lt;NA&gt;       1958/04/18 1958/05/01 1958/04/17 1959/03/23
##  [19] 1959/02/09 1959/09/01 1959/10/01 1963/09/28 1963/01/10 1965/03/09
##  [25] 1965/01/29 1965/11/14 1966/10/06 1967/12/29 1967/09/06 1967/03/11
##  [31] &lt;NA&gt;       &lt;NA&gt;       1968/09/13 1969/09/29 1969/03/22 1969/09/29
##  [37] 1969/08/12 1969/09/29 1969/09/29 2006/03/18 2006/03/18 1970/04/21
##  [43] 1970/02/03 1970/02/05 1971/03/23 &lt;NA&gt;       1971/07/20 1972/10/14
##  [49] 1972/03/11 1972/12/07 &lt;NA&gt;       1972/05/01 1973/02/27 1973/04/24
##  [55] 1973/02/27 &lt;NA&gt;       &lt;NA&gt;       1974/12/09 &lt;NA&gt;       1975/02/15
##  [61] 1975/11/26 1975/12/12 &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;      
##  [67] 1976/01/30 1978/09/07 1978/09/18 1978/10/05 1978/09/26 1978/10/25
##  [73] 1979/12/25 1979/08/06 1979/08/24 1979/04/22 &lt;NA&gt;       1979/08/13
##  [79] 1979/01/03 1979/08/14 1979/08/21 1980/07/21 1980/06/02 1980/06/02
##  [85] 1980/08/14 1980/05/12 1980/08/25 1980/06/02 1980/08/21 1980/05/29
##  [91] &lt;NA&gt;       1981/06/10 &lt;NA&gt;       &lt;NA&gt;       1981/02/20 1982/08/16
##  [97] &lt;NA&gt;       1982/05/14 1982/08/23 1982/09/22 1982/08/25 1982/05/12
## [103] 1982/09/22 1982/05/14 1982/08/17 &lt;NA&gt;       1984/11/07 1984/03/09
## [109] 1984/03/22 1984/11/30 1985/02/02 &lt;NA&gt;       1985/02/02 1985/11/18
## [115] 1986/12/14 1986/01/02 1986/01/14 1987/04/13 &lt;NA&gt;       1987/04/03
## [121] 1987/01/24 1988/01/17 1988/12/28 1988/12/28 1988/12/28 1988/12/28
## [127] 1989/12/15 1989/01/15 1989/01/18 1989/03/09 1989/04/26 &lt;NA&gt;      
## [133] 1990/05/25 1991/05/12 1991/04/30 1991/05/12 1991/05/01 1991/05/12
## [139] 1991/05/12 1993/05/17 1993/01/13 1993/05/17 1993/10/27 1994/02/04
## [145] 1994/02/24 1995/12/16 &lt;NA&gt;       1995/05/23 1997/01/23 1998/10/15
## [151] 1998/02/15 1998/12/29 1998/05/15 1998/01/12 1998/05/15 1998/10/19
## [157] 1998/03/05 &lt;NA&gt;       1999/12/12 &lt;NA&gt;       2000/10/11 &lt;NA&gt;      
## [163] 2000/01/06 &lt;NA&gt;       2001/03/06 2001/10/04 2002/05/09 2002/01/20
## [169] 2002/04/19 2002/01/01 2002/12/06 2002/02/24 2004/12/22 2004/09/21
## [175] 2004/04/02 2005/10/11 2005/10/27 2005/03/01 2005/11/09 2005/11/28
## [181] 2005/12/01 2006/03/13 2006/02/06 2006/12/05 2006/03/28 2006/09/29
## [187] 2006/12/23 2007/10/26 2007/01/19 2007/01/05 2007/03/02 2007/03/02
## [193] 2008/02/08 2008/01/12 2008/02/07 2008/02/05 2009/12/17 2009/02/06
## [199] 2009/03/11 2009/12/10 2010/02/10 2010/02/21 2011/12/18 2011/03/16
## [205] 2011/02/18 2011/01/31 2012/02/22 2012/12/14 2012/02/21 2012/12/15
## [211] 2012/12/21 2012/11/08 2012/11/20 2013/02/02 2013/02/02 2013/12/10
## [217] 2013/02/05 2013/01/16 2013/02/05 2013/01/31 2013/03/11 2013/12/20
## [223] 2013/01/30 2013/01/25 2013/01/16 2013/01/25 2014/02/13 2014/12/19
## [229] 2014/09/22 2014/04/21 2014/02/14 2014/07/22 2015/02/21 2015/02/07
## [235] 2015/10/23 2015/09/14 2015/09/14 2015/09/14 2015/09/14 2015/11/21
## [241] 2015/09/14 2015/12/29 2015/02/20 2016/04/19 2016/01/09 2016/05/23
## [247] 2016/01/17 2016/01/17 2016/01/20 2016/03/05 2016/04/15
## 2454 Levels: 1927/05/28 1930/12/28 1931/01/18 1932/08/17 ... 2016/07/05</code></pre>
<pre class="r"><code>sum(firelayers$Area_ha[is.na(firelayers$Datestart)])/sum(firelayers$Area_ha) # Proportion of burnt area without start date...</code></pre>
<pre><code>## [1] 0.07952637</code></pre>
<pre class="r"><code>firelayers$Year #Lets use &quot;Year&quot; instead...</code></pre>
<pre><code>##   [1] 1944 1945 1945 1945 1947 1948 1955 1956 1956 1958 1958 1958 1958 1958
##  [15] 1958 1958 1958 1959 1959 1959 1959 1963 1963 1965 1965 1965 1966 1967
##  [29] 1967 1967 1967 1968 1968 1969 1969 1969 1969 1969 1969 1970 1970 1970
##  [43] 1970 1970 1971 1971 1971 1972 1972 1972 1972 1972 1973 1973 1973 1974
##  [57] 1974 1974 1975 1975 1975 1975 1975 1975 1976 1976 1976 1978 1978 1978
##  [71] 1978 1978 1979 1979 1979 1979 1979 1979 1979 1979 1979 1980 1980 1980
##  [85] 1980 1980 1980 1980 1980 1980 1981 1981 1981 1981 1981 1982 1982 1982
##  [99] 1982 1982 1982 1982 1982 1982 1982 1984 1984 1984 1984 1984 1985 1985
## [113] 1985 1985 1986 1986 1986 1987 1987 1987 1987 1988 1988 1988 1988 1988
## [127] 1989 1989 1989 1989 1989 1990 1990 1991 1991 1991 1991 1991 1991 1993
## [141] 1993 1993 1993 1994 1994 1995 1995 1995 1997 1998 1998 1998 1998 1998
## [155] 1998 1998 1998 1999 1999 1999 2000 2000 2000 2000 2001 2001 2002 2002
## [169] 2002 2002 2002 2002 2004 2004 2004 2005 2005 2005 2005 2005 2005 2006
## [183] 2006 2006 2006 2006 2006 2007 2007 2007 2007 2007 2008 2008 2008 2008
## [197] 2009 2009 2009 2009 2010 2010 2011 2011 2011 2011 2012 2012 2012 2012
## [211] 2012 2012 2012 2013 2013 2013 2013 2013 2013 2013 2013 2013 2013 2013
## [225] 2013 2013 2014 2014 2014 2014 2014 2014 2015 2015 2015 2015 2015 2015
## [239] 2015 2015 2015 2015 2015 2016 2016 2016 2016 2016 2016 2016 2016</code></pre>
<p><br></p>
<p>Now we’re going to loop through our fire years and rasterize them one by one. There are some issues we need to address though:</p>
<ul>
<li><p>Firstly, this may create a large object in R’s memory and slow it down. We can get around this by writing each raster out to a file. Geotif and some other formats allow writing multiple rasters to one file. We should also dump any unwanted objects from memory using rm().</p></li>
<li><p>Secondly, if there are a lot of cells in the raster and/or there are a lot of layers this operation may take some time either way. If we are on a multicore machine we can speed things up by parallelizing our code.</p></li>
<li><p>Thirdly, in this case we would like rasters for all years even if there were no fires (you’ll see why in a minute). We’ll use if() statements to identify years with no fires and fill these in with empty rasters (0’s only).</p></li>
<li><p>Lastly, if you end out running the code multiple times then you don’t want to have to repeat big operations like this. We can use file.exists() combined with an if() statement to only run this chunk of code if the file does not exist.</p></li>
</ul>
<p><br></p>
<p>First let’s dump unwanted objects from memory and try rasterizing the fires on a single core using a normal <em>for</em> loop.</p>
<p><br></p>
<pre class="r"><code>rm(&quot;aspect&quot;,&quot;slope&quot;, &quot;eastwest&quot;, &quot;northsouth&quot;, &quot;TPI&quot;, &quot;TRI&quot;, &quot;roughness&quot;, &quot;flowdir&quot;)

years &lt;- min(firelayers$Year):max(firelayers$Year) # Get the unique list of years

rfifile &lt;- paste0(datwd, &quot;fires_annual_90m.tif&quot;) # Set a file name

system.time( # To time the process
if(!file.exists(rfifile)) { # Check if the file exists. If not, run this
td &lt;- list() # Create an empty list
# Loop through years making a raster of burnt cells (1/0) for each
  for (i in 1:length(years)) { 
  y &lt;- years[i] # The index year
  # If no fires that year, return a raster of zeros
  if(sum(firelayers$Year==y)==0)  
      td[[i]] &lt;-  raster(extent(dem),res=res(dem),vals=0)
  # If there are fires, rasterize
  if(sum(firelayers$Year==y)&gt;0) 
      td[[i]] &lt;- rasterize(firelayers[which(firelayers$Year==y),],dem, field=&quot;Year&quot;, fun=&quot;count&quot;, background=0) 
  } # End loop
rfi &lt;- stack(td) 
writeRaster(rfi,file=rfifile) # Write out rasters to one file
} # End if() statement
) # End timing</code></pre>
<pre><code>##    user  system elapsed 
##       0       0       0</code></pre>
<p><br></p>
<p>Now lets try it in parallel using the <em>foreach/%dopar%</em> loop in library(doMC)…</p>
<p><br></p>
</div>
<div id="going-parallel" class="section level3">
<h3>Going parallel!</h3>
<p><br></p>
<pre class="r"><code>registerDoMC(3) # Set the computer up as a cluster with 3 cores (I have 4, but want to save 1 for other programmes)

rfifileP &lt;- paste0(datwd, &quot;fires_annual_90m_parallel.tif&quot;) # Set a file name

system.time( # To time the process
if(!file.exists(rfifileP)) { # Check if the file exists. If not, run this
# Start parallel processing
rfi &lt;- foreach(y=years,.combine=stack,.packages=&quot;raster&quot;) %dopar% { 
 # Loop through years making a raster of burnt cells (1/0) for each
  # Check if there were any fires that year, if not, return zeros
  if(sum(firelayers$Year==y)==0) 
      td &lt;-  raster(extent(dem),res=res(dem),vals=0)
  # If there are fires, rasterize
  if(sum(firelayers$Year==y)&gt;0)
      td &lt;- rasterize(firelayers[which(firelayers$Year==y),],dem, field=&quot;Year&quot;, fun=&quot;count&quot;, background=0) 
  # Return the individual raster
  return(td)
  } # End parallelized code
writeRaster(rfi,file=rfifileP) # Write out the set of rasters to one file
} # End if() statement
) # End timing</code></pre>
<pre><code>##    user  system elapsed 
##       0       0       0</code></pre>
<p><br></p>
<p>Not much time difference here, but then this is a small example and most of the time is spent interpreting the input code rather than processing. Going parallel really pays when crunching big analyses…</p>
<p>Now lets read in the data and plot them.</p>
<p><br></p>
<pre class="r"><code>rfi &lt;- stack(rfifile) # Read the files back in as a stack
rfi # Look at the stack</code></pre>
<pre><code>## class       : RasterStack 
## dimensions  : 272, 257, 69904, 73  (nrow, ncol, ncell, nlayers)
## resolution  : 78.3, 92.4  (x, y)
## extent      : 314587.6, 334710.7, 6409924, 6435056  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=utm +zone=34 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0 
## names       : fires_annual_90m.1, fires_annual_90m.2, fires_annual_90m.3, fires_annual_90m.4, fires_annual_90m.5, fires_annual_90m.6, fires_annual_90m.7, fires_annual_90m.8, fires_annual_90m.9, fires_annual_90m.10, fires_annual_90m.11, fires_annual_90m.12, fires_annual_90m.13, fires_annual_90m.14, fires_annual_90m.15, ...</code></pre>
<pre class="r"><code>names(rfi)=paste0(&quot;Fire_&quot;,years) # Add year as name for each raster
rfi &lt;- crop(rfi, E) # Crop to just our area of interest (speeds things up)
plot(rfi) # Plot all layers</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p><br></p>
<p>Pretty messy… there must be a sexier way?</p>
<p><br></p>
</div>
<div id="animation" class="section level3">
<h3>Animation!</h3>
<p>There are more and more ways of producing cool animations and interactive graphics in R. Here’s a simple example using library(animation). Note that this reqires installing the stand-alone software <a href="http://www.imagemagick.org/" class="uri">http://www.imagemagick.org/</a>.</p>
<p><br></p>
<pre class="r"><code>if(!file.exists(paste0(reswd,&quot;fires.gif&quot;))) { # Check if the file exists
  saveGIF({
    for (i in 1:dim(rfi)[3]) plot(rfi[[i]],
                      main=names(rfi)[i],
                      legend.lab=&quot;Fire!&quot;,
                      col=rev(terrain.colors(2)),
                      breaks=c(-0.1,.1,1.1))}, 
    movie.name = paste0(reswd,&quot;fires.gif&quot;), 
    ani.width = 480, ani.height = 600, 
    interval=.5)
}</code></pre>
<p><br></p>
<div class="figure">
<img src="/img/fires.gif" />

</div>
<p><br></p>
<p>Hmm… not that impressive… What if we take advantage of raster calculations and add all the rasters leading up to each time step using sum()?</p>
<p><br></p>
<pre class="r"><code>if(!file.exists(paste0(reswd,&quot;firesadded.gif&quot;))) { # Check if the file exists
  saveGIF({
    for (i in 1:dim(rfi)[3]) plot(sum(rfi[[1:i]], na.rm=T), #Note the summing of rasters 1 to i
                      main=names(rfi)[i],
                      legend.lab=&quot;Fire!&quot;,
                      col=rev(terrain.colors(11)),
                      breaks=c(seq(-0.5,10.5,1)))}, 
    movie.name = paste0(reswd,&quot;firesadded.gif&quot;), 
    ani.width = 480, ani.height = 600, 
    interval=.5)
}</code></pre>
<p><br></p>
<div class="figure">
<img src="/img/firesadded.gif" />

</div>
<p><br></p>
</div>
<div id="some-other-data-visualization-and-analysis" class="section level3">
<h3>Some other data visualization and analysis</h3>
<p><br></p>
<pre class="r"><code># Plotting functions in library(rasterVis)
levelplot(dem)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<pre class="r"><code>contourplot(dem)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-27-2.png" width="672" /></p>
<pre class="r"><code>persp(dem)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-27-3.png" width="672" /></p>
<p><br></p>
<p>Some fancy tricks with Google Earth…</p>
<p><br></p>
<pre class="r"><code>gbmap &lt;- gmap(Mercator(rawpts), type = &quot;satellite&quot;)</code></pre>
<pre><code>## Warning in as.POSIXlt.POSIXct(x, tz): unknown timezone &#39;default/Africa/
## Johannesburg&#39;</code></pre>
<pre class="r"><code>plot(gbmap)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<pre class="r"><code>points(Mercator(rawpts), pch = 20, col = &quot;red&quot;, cex=.3)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-28-2.png" width="672" /></p>
<p><br></p>
<p>If you thought that was fancy, check this out! (Note that this only works for embedding into RMarkdown or an html page)</p>
<p><br></p>
<pre class="r"><code>op &lt;- options(gvis.plot.tag=&quot;chart&quot;) # Set gvis options for rmarkdown

points.gb &lt;- as.data.frame(rawpts[sample(1:1000, 20),]) # Just select a few trees
points.gb$latlon &lt;- paste(points.gb$coords.x2, points.gb$coords.x1, sep=&quot;:&quot;)
map.gb &lt;- gvisMap(points.gb, locationvar=&quot;latlon&quot;, tipvar=&quot;Name&quot;)
plot(map.gb)</code></pre>
<!-- Map generated in R 3.4.2 by googleVis 0.6.2 package -->
<!-- Tue Feb 13 17:13:19 2018 -->
<!-- jsHeader -->
<script type="text/javascript">
 
// jsData 
function gvisDataMapID14b5f6b2374f () {
var data = new google.visualization.DataTable();
var datajson =
[
 [
-32.33270581,
19.16365065,
""
],
[
-32.2999858,
19.13770004,
""
],
[
-32.34294911,
19.17310992,
""
],
[
-32.28597077,
19.11169719,
""
],
[
-32.39818109,
19.20579819,
""
],
[
-32.2861957,
19.11150366,
""
],
[
-32.23579176,
19.08191324,
""
],
[
-32.40808433,
19.16811032,
""
],
[
-32.33987331,
19.12859551,
""
],
[
-32.34505456,
19.1235732,
""
],
[
-32.28239718,
19.13514051,
""
],
[
-32.21763977,
19.07533489,
""
],
[
-32.33319262,
19.17572325,
""
],
[
-32.23668888,
19.09185488,
""
],
[
-32.35873869,
19.0724481,
""
],
[
-32.23623904,
19.08043058,
""
],
[
-32.33671638,
19.13637937,
""
],
[
-32.33508886,
19.18633291,
""
],
[
-32.33223254,
19.1149082,
""
],
[
-32.32449632,
19.12243733,
""
] 
];
data.addColumn('number','Latitude');
data.addColumn('number','Longitude');
data.addColumn('string','Name');
data.addRows(datajson);
return(data);
}
 
// jsDrawChart
function drawChartMapID14b5f6b2374f() {
var data = gvisDataMapID14b5f6b2374f();
var options = {};
options["showTip"] = true;

    var chart = new google.visualization.Map(
    document.getElementById('MapID14b5f6b2374f')
    );
    chart.draw(data,options);
    

}
  
 
// jsDisplayChart
(function() {
var pkgs = window.__gvisPackages = window.__gvisPackages || [];
var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
var chartid = "map";
  
// Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
var i, newPackage = true;
for (i = 0; newPackage && i < pkgs.length; i++) {
if (pkgs[i] === chartid)
newPackage = false;
}
if (newPackage)
  pkgs.push(chartid);
  
// Add the drawChart function to the global list of callbacks
callbacks.push(drawChartMapID14b5f6b2374f);
})();
function displayChartMapID14b5f6b2374f() {
  var pkgs = window.__gvisPackages = window.__gvisPackages || [];
  var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
  window.clearTimeout(window.__gvisLoad);
  // The timeout is set to 100 because otherwise the container div we are
  // targeting might not be part of the document yet
  window.__gvisLoad = setTimeout(function() {
  var pkgCount = pkgs.length;
  google.load("visualization", "1", { packages:pkgs, callback: function() {
  if (pkgCount != pkgs.length) {
  // Race condition where another setTimeout call snuck in after us; if
  // that call added a package, we must not shift its callback
  return;
}
while (callbacks.length > 0)
callbacks.shift()();
} });
}, 100);
}
 
// jsFooter
</script>
<!-- jsChart -->
<script type="text/javascript" src="https://www.google.com/jsapi?callback=displayChartMapID14b5f6b2374f"></script>
<!-- divChart -->
<div id="MapID14b5f6b2374f" style="width: 500; height: automatic;">

</div>
<pre class="r"><code>options(op) # Reset gvis options to default</code></pre>
<p><br></p>
</div>
<div id="but-what-about-our-poor-cedars" class="section level3">
<h3>But what about our poor cedars?</h3>
<p>I haven’t shown you how to extract the data!</p>
<p><br></p>
<pre><code>## null device 
##           1</code></pre>
<pre class="r"><code>topo$fire &lt;- firecount
topo$dens &lt;- dens
plot(topo)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-1.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-2.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-3.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-4.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-5.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-6.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-7.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-8.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-9.png" width="672" /><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-31-10.png" width="672" /></p>
<p><br></p>
<p>Current theories around the cedar’s decline include increased fire frequency and climate change. Here are a couple of basic hypotheses we could test:</p>
<ul>
<li><p>Under increased fire frequency we would expect fewer cedars in areas where greater numbers of fires occur, but higher survival in areas with greater topographic roughness as this may provide refuge from fire (note that just the perimeters are mapped for most fires).</p></li>
<li><p>Under climate change we may expect cedars to be more numerous at higher altitudes, at more northern latitudes, and on South-facing slopes.</p></li>
</ul>
<p><br></p>
<pre class="r"><code># Here&#39;s an easy way to get all data and fiddle.
dat = as.data.frame(topo) #check out ?rasterToPoints too

par(mfrow=c(2,2))
plot(dens ~ fire, data=dat)
plot(dens ~ tri, data=dat)
plot(dens ~ dem, data=dat)
plot(dens ~ northsouth, data=dat)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<pre class="r"><code>par(mfrow=c(1,1))

# Or just extract the locations we want (note that there&#39;ll be repetition of cells with multiple cedars)
dat = as.data.frame(extract(topo, pts))

par(mfrow=c(2,2))
plot(dens ~ fire, data=dat)
plot(dens ~ tri, data=dat)
plot(dens ~ dem, data=dat)
plot(dens ~ northsouth, data=dat)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-32-2.png" width="672" /></p>
<pre class="r"><code>par(mfrow=c(1,1))</code></pre>
<p><br></p>
<p>We can also model the species’ distribution based on these variables using functions in the package <em>dismo</em>. Here I just do a BioClim model, but you can run many other models too. Even MaxEnt is available if you install it separately and tell R where it is on your machine.</p>
<p><br></p>
<pre class="r"><code>bc &lt;- bioclim(topo[[-10]], pts) # The [[-10]] tells R not to use the 10th raster (dens) in the model fitting as this would be circular...

p &lt;- predict(topo, bc) # Predict potential distribution back onto base data
plot(p)
points(pts, pch=20, cex=.1)</code></pre>
<p><img src="/post/2017-04-01-PrimerSpatialData_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p><br></p>
<p>Type vignette(“sdm”) to get a tutorial on Species Distribution Modelling in R with dismo.</p>
<p><br></p>
</div>
<div id="options-for-writing-out-spatial-data" class="section level3">
<h3>Options for writing out spatial data</h3>
<p><br></p>
<pre><code>?writeOGR # For shapefiles - can save in many many formats
?writeRaster # For rasters - also has many formats
?save # To write out a subset of objects from the project
?save.image # To write out the whole project with all objects (like a .mxd in ArcGIS really)</code></pre>
<p><br></p>
<p>THANKS!!!</p>
<p>If you try this code and have issues the session info is below. Also note that all kinds of weird settings to Flash etc are required to do the gvisMap plot and it only works if embedded in an HTML webpage or similar.</p>
<p><br></p>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.4.2 (2017-09-28)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS High Sierra 10.13.2
## 
## Matrix products: default
## BLAS: /Library/Frameworks/R.framework/Versions/3.4/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.4/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8
## 
## attached base packages:
## [1] parallel  methods   stats     graphics  grDevices utils     datasets 
## [8] base     
## 
## other attached packages:
##  [1] googleVis_0.6.2     dismo_1.1-4         animation_2.5      
##  [4] doMC_1.3.4          iterators_1.0.8     foreach_1.4.3      
##  [7] rgdal_1.2-16        rasterVis_0.41      latticeExtra_0.6-28
## [10] RColorBrewer_1.1-2  lattice_0.20-35     raster_2.6-7       
## [13] sp_1.2-5           
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_0.12.14      knitr_1.17        magrittr_1.5     
##  [4] viridisLite_0.2.0 stringr_1.2.0     tools_3.4.2      
##  [7] grid_3.4.2        rgeos_0.3-26      htmltools_0.3.6  
## [10] yaml_2.1.14       rprojroot_1.2     digest_0.6.14    
## [13] bookdown_0.5      codetools_0.2-15  evaluate_0.10.1  
## [16] rmarkdown_1.8     blogdown_0.3      stringi_1.1.6    
## [19] compiler_3.4.2    backports_1.1.1   jsonlite_1.5     
## [22] hexbin_1.27.1     zoo_1.8-0</code></pre>
<p><br></p>
</div>
</div>

      </div>
    </div>
  </div>

  <hr/>
  <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'https-jslingsby-github-io';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  

</div>

          </div>
        </div>
        <div class="row site-footer">
          <div class="col-md-12">
            <div class="row">
  <div class="col-md-12 footer-title">
    <h2>
      
      <a href=""> Jasper Slingsby </a>
      
    </h2>
  </div>
</div>
<div class="row">
  <div class="col-md-12 footer-menu">
      <a href="/">Home /</a>
      
      
      <a href="/about">about / </a>
      
      
      
      <a href="/contact">contact / </a>
      
      
      
      
      
      <a href="/publications">publications / </a>
      
      
      
      <a href="/research">research / </a>
      
      
      
      <a href="/students">students / </a>
      
      

  </div>
</div>
<div class="row">
  <div class="col-sm-12">
    <div class="social-media-block-footer">
      
      
      
      <a href="https://twitter.com/JasperSlingsby" data-animate-hover="pulse" class="external twitter">
        <i class="fa fa-twitter"></i>
      </a>
      
      
      
      <a href="mailto:jslingsby@gmail.com" data-animate-hover="pulse" class="email">
        <i class="fa fa-envelope"></i>
      </a>
      
      
      
      
      <a href="https://github.com/jslingsby/" data-animate-hover="pulse">
        <i class="fa fa-github"></i>
      </a>
      

    </div>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>
    <script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.cookie.js"> </script>
<script src="/js/ekko-lightbox.js"></script>
<script src="/js/jquery.scrollTo.min.js"></script>
<script src="/js/masonry.pkgd.min.js"></script>
<script src="/js/imagesloaded.pkgd.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/front.js"></script>

  </body>
</html>
